<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Sifrr</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <style media="screen">
    #spinner {
        width: 30px;
        height: 30px;
        background-color: black;
        position: fixed;
        top: 10px;
        right: 10px;
        animation: rotation 2s infinite linear;
      }

      @keyframes rotation {
    		from {
  				transform: rotate(0deg);
    		}
    		to {
  				transform: rotate(359deg);
    		}
      }
    </style>
</head>

<body>
  <div id="spinner">

  </div>
  <div id='main'>
    <div class="container">
      <div class="jumbotron">
        <div class="row">
          <div class="col-md-6">
            <h1>Sifrr</h1>
          </div>
          <div class="col-md-6">
            <div class="row">
              <div class="col-sm-6 smallpad">
                <button type='button' class='btn btn-primary btn-block' id='run'>Create 1,000 rows</button>
              </div>
              <div class="col-sm-6 smallpad">
                <button type='button' class='btn btn-primary btn-block' id='runlots'>Create 10,000 rows</button>
              </div>
              <div class="col-sm-6 smallpad">
                <button type='button' class='btn btn-primary btn-block' id='add'>Append 1,000 rows</button>
              </div>
              <div class="col-sm-6 smallpad">
                <button type='button' class='btn btn-primary btn-block' id='update'>Update every 10th row</button>
              </div>
              <div class="col-sm-6 smallpad">
                <button type='button' class='btn btn-primary btn-block' id='clear'>Clear</button>
              </div>
              <div class="col-sm-6 smallpad">
                <button type='button' class='btn btn-primary btn-block' id='swaprows'>Swap Rows</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <sifrr-table></sifrr-table>
      <span class="preloadicon glyphicon glyphicon-remove" aria-hidden="true"></span>
    </div>
  </div>
  <script src="/sifrr.dom.js" charset="utf-8"></script>
  <script type="text/javascript">
    Sifrr.Dom.setup();
    Sifrr.Dom.addEvent('click');
    Sifrr.Dom.load('sifrr-table');
    const sft = document.querySelector('sifrr-table');
    var startMeasure = function(name) {
      startTime = performance.now();
      lastMeasure = name;
    }
    var stopMeasure = function() {
      var last = lastMeasure;
      if (lastMeasure) {
        window.setTimeout(function() {
          lastMeasure = null;
          var stop = performance.now();
          var duration = 0;
          console.log(last + " took " + (stop - startTime));
        }, 0);
      }
    }
    let selected = null, from = 1;
    document.getElementById("main").$click = e => {
      let target = e.path ? e.path[0] : e.target;
      startMeasure(target.id || target.className);
      if (target.matches('#add')) {
        //console.log("add");
        sft.state = {
          data: sft.state.data.concat(buildData(1000, sft.state.data.length))
        };
      } else if (target.matches('#run')) {
        //console.log("run");
        sft.state = {
          data: buildData(1000)
        };
      } else if (target.matches('#update')) {
                let state = sft.state,
          l = sft.state.data.length;
        for (let i = 0; i < l; i += 10) {
          state.data[i].label = state.data[i].label + ' !!!';
          // this.data[i] = Object.assign({}, this.data[i], {label: this.data[i].label +' !!!'});
        }
        sft.state = state;
      } else if (target.matches('#hideall')) {
        //console.log("hideAll");
        sft.state = {
          data: []
        };
      } else if (target.matches('#showall')) {
        //console.log("showAll");
        sft.state = {
          data: buildData(1000)
        };
      } else if (target.matches('#runlots')) {
        //console.log("runLots");
        sft.state = {
          data: buildData(10000)
        };
      } else if (target.matches('#clear')) {
        //console.log("clear");
        sft.state = {
          data: []
        };
      } else if (target.matches('#swaprows')) {
        //console.log("swapRows");
        let data = sft.state.data;
        if (data.length > 998) {
          let a = data[1];
          data[1] = data[998];
          data[998] = a;
          sft.state = { data: data };
        }
      } else if (target.matches('.remove')) {
        let id = getParentId(target);
        // console.log("delete",id);
        let state = sft.state.data;
        for(let i = state.length-1; i >= 0; i--){
          if (state[i].id == id) {
            state.splice(i, 1);
          }
        }
        sft.state = { data: state };
      } else if (target.matches('.lbl')) {
        let id = getParentId(target);
        const data = sft.state.data;
        if (selected !== null) data[selected]['class'] = null;
        selected = id - from + 1000;
        data[selected]['class'] = 'danger';
        sft.state = { data: data };
      }
      stopMeasure();
    };

    function _random(max) {
      return Math.round(Math.random() * 1000) % max;
    }

    function buildData(count = 1000) {
      const adjectives = ["pretty", "large", "big", "small", "tall", "short", "long", "handsome", "plain", "quaint", "clean", "elegant", "easy", "angry", "crazy", "helpful", "mushy", "odd", "unsightly", "adorable", "important", "inexpensive",
        "cheap", "expensive", "fancy"
      ];
      const colours = ["red", "yellow", "blue", "green", "pink", "brown", "purple", "brown", "white", "black", "orange"];
      const nouns = ["table", "chair", "house", "bbq", "desk", "car", "pony", "cookie", "sandwich", "burger", "pizza", "mouse", "keyboard"];
      let data = [];
      for (let i = 0; i < count; i++)
        data.push({
          id: i + from,
          label: adjectives[_random(adjectives.length)] + " " + colours[_random(colours.length)] + " " + nouns[_random(nouns.length)]
        });
      from = from + count;
      return data;
    }

    function getParentId(elem) {
      return elem.dataset.id;
    }
  </script>
</body>

</html>