<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Sifrr</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  </head>
  <body>
    <div id='main'>
        <div class="container">
            <div class="jumbotron">
                <div class="row">
                    <div class="col-md-6">
                        <h1>Sifrr</h1>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-sm-6 smallpad">
                                <button type='button' class='btn btn-primary btn-block' id='run'>Create 1,000 rows</button>
                            </div>
                            <div class="col-sm-6 smallpad">
                                <button type='button' class='btn btn-primary btn-block' id='runlots'>Create 10,000 rows</button>
                            </div>
                            <div class="col-sm-6 smallpad">
                                <button type='button' class='btn btn-primary btn-block' id='add'>Append 1,000 rows</button>
                            </div>
                            <div class="col-sm-6 smallpad">
                                <button type='button' class='btn btn-primary btn-block' id='update'>Update every 10th row</button>
                            </div>
                            <div class="col-sm-6 smallpad">
                                <button type='button' class='btn btn-primary btn-block' id='clear'>Clear</button>
                            </div>
                            <div class="col-sm-6 smallpad">
                                <button type='button' class='btn btn-primary btn-block' id='swaprows'>Swap Rows</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <sifrr-table></sifrr-table>
            <span class="preloadicon glyphicon glyphicon-remove" aria-hidden="true"></span>
        </div>
    </div>
    <script src="/sifrr.dom.js" charset="utf-8"></script>
    <script type="text/javascript">
      Sifrr.Dom.setup();
      Sifrr.Dom.load('sifrr-table');
      const sft = document.querySelector('sifrr-table');
      var startMeasure = function(name) {
        startTime = performance.now();
        lastMeasure = name;
      }
      var stopMeasure = function() {
        var last = lastMeasure;
        if (lastMeasure) {
          window.setTimeout(function () {
            lastMeasure = null;
            var stop = performance.now();
            var duration = 0;
            console.log(last+" took "+(stop-startTime));
          }, 0);
        }
      }
      document.getElementById("main").addEventListener('click', e => {
        startMeasure(e.target.id);
        if (e.target.matches('#add')) {
            e.preventDefault();
            //console.log("add");
            sft.state = { data: sft.state.data.concat(buildData(1000, sft.state.data.length)) };
        }
        else if (e.target.matches('#run')) {
            e.preventDefault();
            //console.log("run");
            sft.state = { data: buildData(1000) };
        }
        else if (e.target.matches('#update')) {
            e.preventDefault();
            let state = sft.state, l = sft.state.data.length;
            for (let i=0;i<l;i+=10) {
              state.data[i].label = state.data[i].label + ' !!!';
              // this.data[i] = Object.assign({}, this.data[i], {label: this.data[i].label +' !!!'});
            }
            sft.state = state;
        }
        else if (e.target.matches('#hideall')) {
            e.preventDefault();
            //console.log("hideAll");
            sft.state = { data: [] };
        }
        else if (e.target.matches('#showall')) {
            e.preventDefault();
            //console.log("showAll");
            sft.state = { data: buildData(1000) };
        }
        else if (e.target.matches('#runlots')) {
            e.preventDefault();
            //console.log("runLots");
            sft.state = { data: buildData(10000) };
        }
        else if (e.target.matches('#clear')) {
            e.preventDefault();
            //console.log("clear");
            sft.state = { data: [] };
        }
        else if (e.target.matches('#swaprows')) {
            e.preventDefault();
            //console.log("swapRows");
            let state = sft.state;
            if(state.data.length > 998) {
              const randa = _random(999), randb = (randa + 100) % 999;
              let a = state.data[randa];
              state.data[randa] = state.data[randb];
              state.data[randb] = a;
              sft.state = state;
              console.log(`swaped ${randa} & ${randb}`);
            }
        }
        else if (e.target.matches('.remove')) {
            e.preventDefault();
            let id = getParentId(e.target);
            //console.log("delete",idx);
            let state = sft.state;
            delete state[id];
            sft.state = state;
        }
        else if (e.target.matches('.lbl')) {
            e.preventDefault();
            let id = getParentId(e.target);
            //console.log("select",idx);
            sft.state.selected = id;
        }
        stopMeasure();
      });

      function _random(max) {
        return Math.round(Math.random()*1000)%max;
      }

      function buildData(count = 1000, from = 0) {
        const adjectives = ["pretty", "large", "big", "small", "tall", "short", "long", "handsome", "plain", "quaint", "clean", "elegant", "easy", "angry", "crazy", "helpful", "mushy", "odd", "unsightly", "adorable", "important", "inexpensive", "cheap", "expensive", "fancy"];
        const colours = ["red", "yellow", "blue", "green", "pink", "brown", "purple", "brown", "white", "black", "orange"];
        const nouns = ["table", "chair", "house", "bbq", "desk", "car", "pony", "cookie", "sandwich", "burger", "pizza", "mouse", "keyboard"];
        let data = [];
        for (let i = 0; i < count; i++)
            data.push({ id: i + from, label: adjectives[_random(adjectives.length)] + " " + colours[_random(colours.length)] + " " + nouns[_random(nouns.length)]});
        return data;
      }

    </script>
  </body>
</html>
