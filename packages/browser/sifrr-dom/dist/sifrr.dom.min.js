!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t.Sifrr=t.Sifrr||{},t.Sifrr.Dom=e())}(this,function(){"use strict";const t={createStateMap:function(e){let n=[],r=[];if(Array.isArray(e)){for(;e.length;){const s=t.createStateMap(e.shift());Array.prototype.push.apply(n,s.nodes),Array.prototype.push.apply(r,s.attributes)}return{nodes:n,attributes:r}}if(3===e.nodeType){const t=e.nodeValue;if(t.indexOf("${")>-1){let r=window.document.createElement("sifrr-node");r.appendChild(e.cloneNode()),e.replaceWith(r),n.push({tag:"sifrr-node",data:t,dom:r})}return{nodes:n,attributes:r}}const s=e.attributes||[],a=s.length;for(let t=0;t<a;t++){const n=s[t];n.value.indexOf("${")>-1&&r.push({name:n.name,value:n.value,dom:e})}if("true"==e.contentEditable||"TEXTAREA"==e.nodeName)n.push({tag:e.nodeName,data:e.innerHTML,dom:e});else{const s=t.createStateMap(Array.prototype.slice.call(e.childNodes));Array.prototype.push.apply(n,s.nodes),Array.prototype.push.apply(r,s.attributes)}return{nodes:n,attributes:r}},twoWayBind:function(t){const e=t.path?t.path[0]:t.target;if(!e.dataset.sifrrBind)return;const n=e.value||("blur"==t.type?e.innerHTML.trim().replace(/(&lt;)(((?!&gt;).)*)(&gt;)(((?!&lt;).)*)(&lt;)\/(((?!&gt;).)*)(&gt;)/g,"<$2>$5</$8>").replace(/(&lt;)(input|link|img|br|hr|col|keygen)(((?!&gt;).)*)(&gt;)/g,"<$2$3>"):e.innerHTML);let r=e.getRootNode();r=r.host;let s={};s[e.dataset.sifrrBind]=n,r.state=s},updateState:function(e){if(!e.stateMap)return!1;const n=e.stateMap.nodes,r=n.length;for(let s=0;s<r;s++)t.updateNode(n[s],e);const s=e.stateMap.attributes,a=s.length;for(let n=0;n<a;n++)t.updateAttribute(s[n],e)},updateNode:function(e,n){const r=e.dom.innerHTML,s=t.evaluateString(e.data,n);r!=s&&(e.dom.innerHTML=s)},updateAttribute:function(e,n){e.dom.setAttribute(e.name,t.evaluateString(e.value,n))},evaluateString:function(t,e){return t.indexOf("${")<0?t:0===(t=t.trim()).indexOf("${")?n(t):t.replace(/\${([^{}$]|{([^{}$])*})*}/g,n);function n(t){let n=t.slice(2,-1);return function(){let r;r=n.search("return")>=0?new Function(n).bind(e):new Function("return "+n).bind(e);try{return r()}catch(e){return t}}()}}};var e=t;var n=class{static parse(t){let e={};if("string"==typeof t){try{e=JSON.parse(t)}catch(e){return t}return this.parse(e)}if(Array.isArray(t))e=[],t.forEach((t,n)=>{e[n]=this.parse(t)});else{if("object"!=typeof t)return t;for(const n in t)e[n]=this.parse(t[n])}return e}static stringify(t){return"string"==typeof t?t:JSON.stringify(t)}};"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var r,s=(function(t,e){var n;t.exports=(n=class{constructor(t,e,n){this.type=t,this._options=n,this._url=e}get response(){return window.fetch(this.url,this.options).then(t=>{let e,n=t.headers.get("content-type");if(e=n&&n.includes("application/json")?t.json():t.text(),t.ok)return e;{let n=Error(t.statusText);throw n.response=e,n}})}get url(){let t=delete this._options.params;return t&&Object.keys(t).length>0?this._url+"?"+Object.keys(t).map(e=>encodeURIComponent(e)+"="+encodeURIComponent(t[e])).join("&"):this._url}get options(){return Object.assign(this._options,{method:this.type,headers:Object.assign({accept:"application/json"},this._options.headers||{}),mode:"cors",redirect:"follow"})}},class{static get(t,e={}){return new n("GET",t,e).response}static post(t,e={}){return new n("POST",t,e).response}static put(t,e={}){return new n("PUT",t,e).response}static delete(t,e={}){return new n("DELETE",t,e).response}static file(t,e={}){return e.headers=e.headers||{},e.headers.accept=e.headers.accept||"*/*",new n("GET",t,e).response}})}(r={exports:{}},r.exports),r.exports);class a{constructor(t){if(this.constructor.all[t])return this.constructor.all[t];this.elementName=t,this.constructor.add(t,this)}get template(){return this.html.then(t=>t.querySelector("template"))}get html(){return this._html=this._html||s.file(this.templateUrl).then(t=>(new window.DOMParser).parseFromString(t,"text/html")),this._html}get templateUrl(){return`/elements/${this.elementName.split("-").join("/")}.html`}executeScripts(){return this.html.then(t=>{t.querySelectorAll("script").forEach(t=>{new Function(t.text).bind(window)()})})}static add(t,e){a._all[t]=e}static get all(){return a._all}}a._all={};var i=a;var o=class extends window.HTMLElement{static get observedAttributes(){return["data-sifrr-state"].concat(this.observedAttrs||[])}static get template(){return this._template=this._template||new i(this.elementName).template,this._template}static get elementName(){return this.name.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}constructor(){super();let t=this;this.constructor.template.then(n=>{t.attachShadow({mode:"open"}).appendChild(n.content.cloneNode(!0)),t.stateMap=e.createStateMap(t.shadowRoot),t.shadowRoot.addEventListener("change",e.twoWayBind),e.updateState(this)}),this._state=this.constructor.defaultState||{},this.tag=this.constructor.elementName}connectedCallback(){this.state=n.parse(this.dataset.sifrrState)||{}}disconnectedCallback(){this.shadowRoot?this.shadowRoot.removeEventListener("change",e.twoWayBind):this.removeEventListener("change",e.twoWayBind)}attributeChangedCallback(t,e,r){"data-sifrr-state"===t&&(this.state=n.parse(r))}get state(){return this._state}set state(t){this._lastState=Object.assign({},this.state),Object.assign(this._state,t),e.updateState(this)}isSifrr(t=null){return!t||t==this.constructor.elementName}clearState(){this._lastState=this.state,this._state={},e.updateState(this)}};let l={elements:{}};return l.Element=o,l.Parser=e,l.Loader=i,l.register=function(t){const e=t.elementName;if(e)if(window.customElements.get(e))window.console.warn(`Error creating Element: ${e} - Custom Element with this name is already defined.`);else if(e.indexOf("-")<1)window.console.warn(`Error creating Element: ${e} - Custom Element name must have one dash '-'`);else try{return window.customElements.define(e,t),l.elements[e]=t,!0}catch(t){return window.console.warn(`Error creating Custom Element: ${e} - ${t}`),!1}else window.console.warn("Error creating Custom Element: No name given.",t);return!1},l.setup=function(t={}){l.register(class extends HTMLElement{static get elementName(){return"sifrr-node"}connectedCallback(){this.style.whiteSpace="pre-line"}}),window.document.addEventListener("input",l.Parser.twoWayBind,{capture:!0,passive:!0}),window.document.addEventListener("blur",l.Parser.twoWayBind,{capture:!0,passive:!0})},l.load=function(t){new l.Loader(t).executeScripts()},l});
