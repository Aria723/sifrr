/*! Sifrr.Dom v0.1.0-alpha2 - sifrr project - 2018/12/19 17:57:57 UTC */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t.Sifrr=t.Sifrr||{},t.Sifrr.Dom=e())}(this,function(){"use strict";function t(t,n){if(Array.isArray(n)||(n=Array.prototype.slice.call(n)),0===n.length)return void(t.textContent="");let r=t.childNodes.length;if(r>n.length){let e,s=r,a=t.lastChild;for(;s>n.length;)e=a.previousSibling,t.removeChild(a),a=e,s--}let s=t.firstChild;for(let r,a=0;a<n.length;a++)r=n[a],!s&&r?t.appendChild(r):s=e(s,r).nextSibling}function e(e,n){if(null===n)return e;if("stateChange"===n.type)return e.state!==n.state&&(e.state=n.state),e;if(e.nodeName!==n.nodeName)return e.replaceWith(n),n;if(e.nodeType===window.Node.TEXT_NODE||e.nodeType===window.Node.COMMENT_NODE)return e.nodeValue!==n.nodeValue&&(e.nodeValue=n.nodeValue),e;e.state=n.state;let r,s,a,o,i=e.attributes,l=n.attributes;for(var c=l.length-1;c>=0;--c)a=(o=l[c]).name,r=o.value,e.hasAttribute(a)?(s=e.getAttribute(a))!==r&&("null"!==r&&"undefined"!==r&&"false"!==r&&r?e.setAttribute(a,r):e.removeAttribute(a)):e.setAttribute(a,r);for(var d=i.length-1;d>=0;--d)!1!==(o=i[d]).specified&&(a=o.name,n.hasAttribute(a)||e.removeAttribute(a));return t(e,n.childNodes),e}var n={makeEqual:e,makeChildrenEqual:t};const r=window.document.createTreeWalker(document,NodeFilter.SHOW_ALL,null,!1);r.roll=function(t,e=!1){let n=this.currentNode;for(;--t;)n=e&&e(n)?r.nextSibling()||r.parentNode():r.nextNode();return n};class s{constructor(t,e){this.idx=t,this.ref=e}}var a={walker:r,collect:function(t,e=t.stateMap,n){const s=[];return r.currentNode=t,e.map(t=>s.push({dom:r.roll(t.idx,n),data:t.ref})),s},create:function(t,e,n=!1){let a,o=[],i=0;for(r.currentNode=t;t;)(a=e(t))?(o.push(new s(i+1,a)),i=1):i++,t=n&&n(t)?r.nextSibling()||r.parentNode():r.nextNode();return o},klass:s};const{makeChildrenEqual:o}=n;function i(t){return t.dataset&&"true"==t.dataset.sifrrHtml||"true"==t.contentEditable||"TEXTAREA"==t.nodeName||"STYLE"==t.nodeName}function l(t){if(t.nodeType===window.Node.TEXT_NODE){const e=c.createTextStateMap(t);if(e)return e}else{if(t.nodeType===window.Node.COMMENT_NODE&&"$"==t.nodeValue.trim()[0])return{html:!1,text:t.nodeValue.trim()};if(t.nodeType===window.Node.ELEMENT_NODE){let e={};i(t)&&(e.html=!0,e.text=t.innerHTML.replace(/<!--(.*)-->/g,"$1"));const n=c.createAttributeStateMap(t);if(n&&(e.attributes=n),Object.keys(e).length>0)return e}}}const c={sifrrNode:window.document.createElement("sifrr-node"),collectRefs:(t,e)=>a.collect(t,e,i),createStateMap:function(t){let e;return e=t.useShadowRoot?t.shadowRoot:t,a.create(e,l,i)},createTextStateMap:function(t){const e=t.nodeValue;if(e.indexOf("${")>-1)return{html:!1,text:e}},createAttributeStateMap:function(t){const e=t.attributes||[],n=e.length;let r={};for(let t=0;t<n;t++){const n=e[t];n.value.indexOf("${")>-1&&(r[n.name]=n.value)}if(Object.keys(r).length>0)return r},twoWayBind:function(t){const e=t.path?t.path[0]:t.target;if(!e.dataset.sifrrBind)return;const n=void 0===e.value?e.innerHTML:e.value;let r={};r[e.dataset.sifrrBind]=n,e.getRootNode().host.state=r},updateState:function(t){if(!t._refs)return!1;const e=t._refs.length;for(let n=0;n<e;n++)c.updateNode(t._refs[n],t);"function"==typeof this.onStateUpdate&&this.onStateUpdate()},updateNode:function(t,e){if(t.data.attributes&&c.updateAttribute(t,e),void 0===t.data.html)return;const n=t.dom.innerHTML,r=c.evaluateString(t.data.text,e);if(n!=r){if(void 0===r)return t.dom.textContent="";if(t.data.html){let e;if(Array.isArray(r))e=r;else if(r.nodeType)e=[r];else{const t=c.sifrrNode.cloneNode();t.innerHTML=r.toString().replace(/&amp;/g,"&").replace(/&nbsp;/g," ").replace(/(&lt;)(((?!&gt;).)*)(&gt;)(((?!&lt;).)*)(&lt;)\/(((?!&gt;).)*)(&gt;)/g,"<$2>$5</$8>").replace(/(&lt;)(input|link|img|br|hr|col|keygen)(((?!&gt;).)*)(&gt;)/g,"<$2$3>"),e=t.childNodes}o(t.dom,e)}else{if(t.dom.textContent==r)return;t.dom.textContent=r}}},updateAttribute:function(t,e){const n=t.dom;for(let r in t.data.attributes){const s=c.evaluateString(t.data.attributes[r],e);if("null"!==s&&"undefined"!==s&&"false"!==s&&s){n.getAttribute(r)!=s&&n.setAttribute(r,s)}else n.removeAttribute(r);"SELECT"==n.nodeName&&"value"==r&&(n.value=s)}},evaluateString:function(t,e){return t.indexOf("${")<0?t:(t=t.trim()).match(/^\${([^{}$]|{([^{}$])*})*}$/)?n(t):n("`"+t+"`");function n(t){let n;return"$"==t[0]&&(t=t.slice(2,-1)),(n=t.search("return")>=0?new Function(t).bind(e):new Function("return "+t).bind(e))()}}};var d=c;class u{static parse(t){let e={};if("string"==typeof t){try{e=JSON.parse(t)}catch(e){return t}return this.parse(e)}if(Array.isArray(t))e=[],t.forEach((t,n)=>{e[n]=this.parse(t)});else{if("object"!=typeof t)return t;for(const n in t)e[n]=this.parse(t[n])}return e}static stringify(t){return"string"==typeof t?t:JSON.stringify(t)}static deepClone(t){if(Array.isArray(t))return Array.prototype.slice.call(t);if("object"!=typeof t)return t;let e={};for(let n in t)e[n]=u.deepClone(t[n]);return e}}var h=u;"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var f,p=(function(t,e){var n;t.exports=(n=class{constructor(t,e,n){this.type=t,this._options=n,this._url=e}get response(){return window.fetch(this.url,this.options).then(t=>{let e=t.headers.get("content-type");if(e&&e.includes("application/json")&&(t=t.json()),t.ok)return t;{let e=Error(t.statusText);throw e.response=t,e}})}get url(){let t=delete this._options.params;return t&&Object.keys(t).length>0?this._url+"?"+Object.keys(t).map(e=>encodeURIComponent(e)+"="+encodeURIComponent(t[e])).join("&"):this._url}get options(){return Object.assign(this._options,{method:this.type,headers:Object.assign({accept:"application/json"},this._options.headers||{}),mode:"cors",redirect:"follow"})}},class{static get(t,e={}){return new n("GET",t,e).response}static post(t,e={}){return new n("POST",t,e).response}static put(t,e={}){return new n("PUT",t,e).response}static delete(t,e={}){return new n("DELETE",t,e).response}static file(t,e={}){return e.headers=e.headers||{},e.headers.accept=e.headers.accept||"*/*",new n("GET",t,e).response}})}(f={exports:{}},f.exports),f.exports);class m{constructor(t,e={}){if(this.constructor.all[t])return this.constructor.all[t];this.elementName=t,this.config=e}get html(){const t=this;return p.file(this.htmlUrl).then(t=>t.text()).then(t=>(new window.DOMParser).parseFromString(t,"text/html")).then(e=>(m.add(t.elementName,e.querySelector("template")),e))}get htmlUrl(){return this.config.url||`${this.config.baseUrl||"/"}elements/${this.elementName.split("-").join("/")}.html`}executeScripts(){return this.html.then(t=>{t.querySelectorAll("script").forEach(t=>{new Function(t.text).bind(window)()})})}static add(t,e){m._all[t]=e}static get all(){return m._all}}m._all={};var g=m;const{collect:w,create:y}=a,b=document.createElement("template");function E(t){if(3!==t.nodeType){if(void 0!==t.attributes){const e=Array.from(t.attributes),n=[];for(let t of e){const e=t.value;"$"===e[0]&&n.push({text:e.slice(2,-1),name:t.name})}if(n.length>0)return n}return 0}{let e=t.nodeValue;return"$"===e[0]?(t.nodeValue="",e.slice(2,-1)):0}}function S(t){const e=t._refs,n=e.length;for(let r=0;r<n;r++){const n=e[r].data,s=e[r].dom;Array.isArray(n)?n.forEach(e=>s.setAttribute(e.name,t.state[e.text])):s.nodeValue=t.state[n]}}var N=function(t,e){return"string"==typeof t&&(b.innerHTML=t,t=b.content.firstChild),t.stateMap=y(t,E),t._refs=w(t,t.stateMap),Object.defineProperty(t,"state",{get:()=>t._state,set:e=>{t._state=Object.assign(t._state||{},e),S(t)}}),e&&(t.state=e),t.clone=function(){const n=t.cloneNode(!0);return n._refs=w(n,t.stateMap),Object.defineProperty(n,"state",{get:()=>n._state,set:t=>{n._state=Object.assign(n._state||{},t),S(n)}}),e&&(n.state=e),n},t};var _=class extends window.HTMLElement{static get observedAttributes(){return["data-sifrr-state"].concat(this.observedAttrs||[])}static get template(){return g.all[this.elementName]}static get stateMap(){return this._stateMap=this._stateMap||d.createStateMap(this.template.content),this._stateMap}static get elementName(){return this.name.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}constructor(){super(),this._oldState={},this._state=Object.assign({},this.constructor.defaultState,h.parse(this.dataset.sifrrState),this.state);const t=this.constructor.template.content.cloneNode(!0);this._refs=d.collectRefs(t,this.constructor.stateMap),this.useShadowRoot=!this.constructor.template.dataset.noSr,this.useShadowRoot?(this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(t),this.shadowRoot.addEventListener("change",d.twoWayBind)):this.appendChild(t)}connectedCallback(){d.updateState(this)}disconnectedCallback(){this.useShadowRoot?this.shadowRoot.removeEventListener("change",d.twoWayBind):this.removeEventListener("change",d.twoWayBind)}attributeChangedCallback(t,e,n){"data-sifrr-state"===t&&(this.state=h.parse(n))}get state(){return this._state}set state(t){this._oldState=h.deepClone(this._state),Object.assign(this._state,t),d.updateState(this)}isSifrr(t=null){return!t||t==this.constructor.elementName}clearState(){this._state={},d.updateState(this)}srqs(t){return this.shadowRoot.querySelector(t)}srqsAll(t){return this.shadowRoot.querySelectorAll(t)}static addArrayToDom(t,e){this._arrayToDom=this._arrayToDom||{},this._arrayToDom[t]=N(e)}arrayToDom(t,e=this.state[t]){this._domL=this._domL||{};const n=this._domL[t],r=[],s=e.length;if(n)for(let a=0;a<s;a++)if(a<n)r.push({type:"stateChange",state:e[a]});else{const n=this.constructor._arrayToDom[t].clone();n.state=e[a],r.push(n)}else for(let n=0;n<s;n++){const s=this.constructor._arrayToDom[t].clone();s.state=e[n],r.push(s)}return this._domL[t]=s,r}};const v=(t,e)=>{let n=t.path?t.path[0]:t.target;for(;n;){const t=n[`$${e}`];t&&t(event,e),n=n.parentNode||n.host}},T={};let A={elements:{}};return A.Element=_,A.Parser=d,A.makeEqual=n,A.Loader=g,A.register=function(t){const e=t.elementName;if(e)if(window.customElements.get(e))window.console.warn(`Error creating Element: ${e} - Custom Element with this name is already defined.`);else if(e.indexOf("-")<1)window.console.warn(`Error creating Element: ${e} - Custom Element name must have one dash '-'`);else try{return window.customElements.define(e,t),A.elements[e]=t,!0}catch(t){return window.console.warn(`Error creating Custom Element: ${e} - ${t}`),!1}else window.console.warn("Error creating Custom Element: No name given.",t);return!1},A.addEvent=(t=>!T[t]&&(window.document.addEventListener(t,e=>v(e,t),{capture:!0,passive:!0}),T[t]=!0,!0)),A.setup=function(t){A.config=Object.assign({baseUrl:"/"},t),A.addEvent("input"),A.addEvent("change"),window.document.$input=A.Parser.twoWayBind,window.document.$change=A.Parser.twoWayBind},A.SimpleElement=N,A.load=function(t,e={baseUrl:A.config.baseUrl}){new A.Loader(t,e).executeScripts()},A});
/*! (c) @aadityataparia */
