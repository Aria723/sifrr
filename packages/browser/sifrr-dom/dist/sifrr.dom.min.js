/*! Sifrr.Dom v0.0.1-alpha - sifrr project */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t.Sifrr=t.Sifrr||{},t.Sifrr.Dom=e())}(this,function(){"use strict";var t={absolute:(t,e)=>{let s=t.split("/"),o=e.split("/");s.pop();for(let t=0;t<o.length;t++)"."!=o[t]&&(".."==o[t]?s.pop():s.push(o[t]));return s.join("/")},getRoutes:t=>{"/"!=t[0]&&(t="/"+t);let e=t.indexOf("?");return-1!=e&&(t=t.substring(0,e)),t.split("/")}};const e={parse:t=>{let s={};if("string"==typeof t){try{s=JSON.parse(t)}catch(e){return t}return e.parse(s)}if(Array.isArray(t))s=[],t.forEach((t,o)=>{s[o]=e.parse(t)});else{if("object"!=typeof t)return t;for(const o in t)s[o]=e.parse(t[o])}return s},stringify:t=>"string"==typeof t?t:JSON.stringify(t),shallowEqual:(t,e)=>{for(let s in t)if(!(s in e)||t[s]!=e[s])return!1;for(let s in e)if(!(s in t)||t[s]!=e[s])return!1;return!0},deepClone:t=>{if(Array.isArray(t))return t.map(t=>e.deepClone(t));if("object"!=typeof t||null===t)return t;let s={};for(let o in t)s[o]=e.deepClone(t[o]);return s}};var s=e;var o={updateAttribute:function(t,e,s){if("class"===e)t.className!=s&&(t.className="null"!=s&&"undefined"!=s&&"false"!=s&&s?s:"");else{const o=t.getAttribute(e);o!=s&&("null"!=s&&"undefined"!=s&&"false"!=s&&s?t.setAttribute(e,s):o&&t.removeAttribute(e)),"SELECT"!=t.nodeName&&"INPUT"!=t.nodeName||"value"!=e||(t.value=s)}}},r={SIFRR_NODE:window.document.createElement("template"),TEXT_NODE:3,COMMENT_NODE:8,ELEMENT_NODE:1};const{updateAttribute:n}=o,{shallowEqual:i}=s,{TEXT_NODE:a,COMMENT_NODE:f}=r;function c(t,e){const s=t.childNodes.length,o=e.length;if(s>o){let e=s;for(;e>o;)t.removeChild(t.lastChild),e--}else if(s<o){let r=s;for(;r<o;)t.appendChild(e[r]),r++}const r=Math.min(o,s);for(let s,o=0,n=t.firstChild;o<r;o++)n=p(n,s=e[o]).nextSibling}function p(t,e){if(null===e)return t;if("stateChange"===e.type)return i(t.state,e.state)||(t.state=e.state),t;if(t.nodeName!==e.nodeName)return t.replaceWith(e),e;if(t.nodeType===a||t.nodeType===f)return t.data!==e.data&&(t.data=e.data),t;e.state&&(t.state=e.state);let s,o=t.attributes,r=e.attributes;for(let e=r.length-1;e>=0;--e)n(t,r[e].name,r[e].value);for(let r=o.length-1;r>=0;--r)s=o[r],e.hasAttribute(s.name)||!1===s.specified||t.removeAttribute(s.name);return c(t,e.childNodes),t}var u={makeEqual:p,makeChildrenEqual:c};const h=window.document.createTreeWalker(document,NodeFilter.SHOW_ALL,null,!1);h.roll=function(t,e=!1){let s=this.currentNode;for(;--t;)s=e&&e(s)?h.nextSibling()||h.parentNode():h.nextNode();return s};class l{constructor(t,e){this.idx=t,this.ref=e}}var g={walker:h,collect:function(t,e=t.stateMap,s){const o=[];return h.currentNode=t,e.map(t=>o.push(h.roll(t.idx,s))),o},create:function(t,e,s=!1){let o,r=[],n=0;for(h.currentNode=t;t;)(o=e(t))?(r.push(new l(n+1,o)),n=1):n++,t=s&&s(t)?h.nextSibling()||h.parentNode():h.nextNode();return r},klass:l};const{makeChildrenEqual:d}=u,{updateAttribute:b}=o,{collect:m,create:y}=g,{SIFRR_NODE:E,TEXT_NODE:_,COMMENT_NODE:v,ELEMENT_NODE:N}=r;function T(t){return t.dataset&&"true"==t.dataset.sifrrHtml||"true"==t.contentEditable||"TEXTAREA"==t.nodeName||"STYLE"==t.nodeName||t.dataset&&t.dataset.sifrrRepeat}function S(t){if(t.nodeType===_){const e=t.nodeValue;if(e.indexOf("${")>-1)return{html:!1,text:e}}else{if(t.nodeType===v&&"$"==t.nodeValue.trim()[0])return{html:!1,text:t.nodeValue.trim()};if(t.nodeType===N){const e={};if(T(t)){const s=t.innerHTML;s.indexOf("${")>=0&&(e.html=!0,e.text=s.replace(/<!--(.*)-->/g,"$1"))}const s=t.attributes||[],o=s.length,r={};for(let t=0;t<o;t++){const e=s[t];e.value.indexOf("${")>=0&&(r[e.name]=e.value)}if(Object.keys(r).length>0&&(e.attributes=r),Object.keys(e).length>0)return e}}return 0}const O={collectRefs:(t,e)=>m(t,e,T),createStateMap:t=>{let e;return e=t.useShadowRoot?t.shadowRoot:t,y(e,S,T)},updateState:t=>{if(!t._refs)return!1;const e=t._refs.length;for(let s=0;s<e;s++){const e=t.constructor.stateMap[s].ref,o=t._refs[s];if(e.attributes)for(let s in e.attributes){const r=O.evaluateString(e.attributes[s],t);b(o,s,r)}if(void 0===e.html)continue;const r=O.evaluateString(e.text,t);if(r)if(e.html){let t;if(Array.isArray(r))t=r;else if(r.nodeType)t=[r];else{const e=E.cloneNode();e.innerHTML=r.toString().replace(/(&lt;)(((?!&gt;).)*)(&gt;)(((?!&lt;).)*)(&lt;)\/(((?!&gt;).)*)(&gt;)/g,"<$2>$5</$8>").replace(/(&lt;)(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)(((?!&gt;).)*)(&gt;)/g,"<$2$3>"),t=Array.prototype.slice.call(e.content.childNodes)}t.length<1?o.textContent="":d(o,t)}else o.nodeValue!=r&&(o.nodeValue=r);else o.textContent=""}},twoWayBind:t=>{const e=t.path?t.path[0]:t.target;if(!e.dataset.sifrrBind)return;const s=void 0===e.value?e.innerHTML:e.value;let o={};o[e.dataset.sifrrBind]=s,e.getRootNode().host.state=o},evaluateString:(t,e)=>{return t.indexOf("${")<0?t:(t=t.trim()).match(/^\${([^{}$]|{([^{}$])*})*}$/)?s(t):s("`"+t+"`");function s(t){let s;return"$"==t[0]&&(t=t.slice(2,-1)),(s=t.indexOf("return ")>=0?new Function(t).bind(e):new Function("return "+t).bind(e))()}}};var x=O;"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var C,A=(function(t,e){var s;t.exports=(s=class{constructor(t,e,s){this.type=t,this._options=s,this._url=e}get response(){return window.fetch(this.url,this.options).then(t=>{let e=t.headers.get("content-type");if(t.ok)return e&&e.includes("application/json")&&(t=t.json()),t;{let e=Error(t.statusText);throw e.response=t,e}})}get url(){const t=this._options.params;return t&&Object.keys(t).length>0?this._url+"?"+Object.keys(t).map(e=>encodeURIComponent(e)+"="+encodeURIComponent(t[e])).join("&"):this._url}get options(){const t=Object.assign({method:this.type,mode:"cors",redirect:"follow"},this._options);return t.headers=Object.assign({accept:"application/json"},this._options.headers||{}),t}},class{static get(t,e={}){return new s("GET",t,e).response}static post(t,e={}){return new s("POST",t,e).response}static put(t,e={}){return new s("PUT",t,e).response}static delete(t,e={}){return new s("DELETE",t,e).response}static file(t,e={}){return e.headers=e.headers||{},e.headers.accept=e.headers.accept||"*/*",new s("GET",t,e).response}})}(C={exports:{}},C.exports),C.exports);class M{constructor(t,e={}){if(this.constructor.all[t])return this.constructor.all[t].instance;this.elementName=t,this.config=e,this.constructor.urls[t]=this.htmlUrl}get html(){const t=this;return A.file(this.htmlUrl).then(t=>t.text()).then(t=>(new window.DOMParser).parseFromString(t,"text/html")).then(e=>(M.add(t.elementName,{instance:t,template:e.querySelector("template")}),e))}get htmlUrl(){return this.config.url||`${this.config.baseUrl||"/"}elements/${this.elementName.split("-").join("/")}.html`}executeScripts(){return this.html.then(t=>{t.querySelectorAll("script").forEach(t=>{new Function(t.text).bind(window)()})})}static add(t,e){M._all[t]=e}static get all(){return M._all}}M._all={},M.urls={};var j=M;const{collect:L,create:$}=g,{SIFRR_NODE:R}=r;function U(t){if(3!==t.nodeType){if(void 0!==t.attributes){const e=Array.from(t.attributes),s=e.length,o=[];for(let t=0;t<s;t++){const s=e[t].value;"$"===s[0]&&o.push({name:e[t].name,text:s.slice(2,-1)})}if(o.length>0)return o}return 0}{let e=t.nodeValue;return"$"===e[0]?(t.nodeValue="",e.slice(2,-1)):0}}function D(t){const e=t._refs,s=t.stateMap,o=s.length,r=t.state,n=t._oldState;for(let t=0;t<o;t++){const o=s[t].ref,i=e[t];if(Array.isArray(o)){const t=o.length;for(let e=0;e<t;e++){const t=o[e];n[t.text]!==r[t.text]&&("class"===t.name?i.className=r[t.text]||"":i.setAttribute(t.name,r[t.text]))}}else n[o]!=r[o]&&(i.nodeValue=r[o])}}var P=function(t,e){return"string"==typeof t&&(R.innerHTML=t,t=R.content.firstElementChild||R.content.firstChild),t.isSifrr&&t.isSifrr()?t:(t.stateMap=$(t,U),t._refs=L(t,t.stateMap),Object.defineProperty(t,"state",{get:()=>t._state,set:e=>{t._oldState=Object.assign({},t._state),t._state=Object.assign(t._state||{},e),D(t)}}),e&&(t.state=e),t.sifrrClone=function(e){const s=t.cloneNode(e);return s.stateMap=t.stateMap,s._refs=L(s,t.stateMap),Object.defineProperty(s,"state",{get:()=>s._state,set:t=>{s._oldState=Object.assign({},s._state),s._state=Object.assign(s._state||{},t),D(s)}}),t.state&&(s.state=t.state),s},t)};var k=class extends window.HTMLElement{static get observedAttributes(){return["data-sifrr-state"].concat(this.observedAttrs())}static observedAttrs(){return[]}static get template(){return j.all[this.elementName].template}static get stateMap(){return this._stateMap=this._stateMap||x.createStateMap(this.template.content),this._stateMap}static get elementName(){return this.name.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}static onStateChange(){}constructor(){super(),this._state=Object.assign({},this.constructor.defaultState,this.state);const t=this.constructor.template.content.cloneNode(!0);this._refs=x.collectRefs(t,this.constructor.stateMap),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(t),this.shadowRoot.addEventListener("change",x.twoWayBind)}connectedCallback(){this.hasAttribute("data-sifrr-state")||this.updateState(),this.onConnect()}onConnect(){}disconnectedCallback(){this.useShadowRoot&&this.shadowRoot.removeEventListener("change",x.twoWayBind),this.onDisconnect()}onDisconnect(){}attributeChangedCallback(t,e,o){"data-sifrr-state"===t&&(this.state=s.parse(o)),this.onAttributeChange(t,e,o)}onAttributeChange(){}get state(){return this._state}set state(t){Object.assign(this._state,t),this.updateState()}updateState(){x.updateState(this),this.onStateChange(),this.constructor.onStateChange(this)}onStateChange(){}isSifrr(t=null){return!t||t===this.constructor.elementName}sifrrClone(t){const e=this.cloneNode(t);return e._refs=x.collectRefs(e.shadowRoot,this.constructor.stateMap),e.state=this.defaultState,e}clearState(){this._state={},this.updateState()}qs(t,e=!0){return this.useShadowRoot&&e?this.shadowRoot.querySelector(t):this.querySelector(t)}qsAll(t,e=!0){return this.useShadowRoot&&e?this.shadowRoot.querySelectorAll(t):this.querySelectorAll(t)}static addArrayToDom(t,e){this._arrayToDom=this._arrayToDom||{},this._arrayToDom[t]=P(e)}arrayToDom(t,e=this.state[t]){this._domL=this._domL||{};const s=this._domL[t]||0,o=[],r=e.length,n=this.constructor._arrayToDom[t];for(let t=0;t<r;t++)if(t<s)o.push({type:"stateChange",state:e[t]});else{const s=n.sifrrClone(!0);s.state=e[t],o.push(s)}return this._domL[t]=r,o}};const W={},B=(t,e,s)=>{function o(e){e.forEach(e=>e(t,s))}for(let t in W[e])("function"==typeof s.matches&&s.matches(t)||9===s.nodeType&&"document"===t)&&o(W[e][t])};var H={add:t=>!W[t]&&(window.document.addEventListener(t,e=>((t,e)=>Promise.resolve((()=>{let s=t.path?t.path[0]:t.target;for(;s;){const o=s[`$${e}`];o&&o(t,s),B(t,e,s),s=s.parentNode||s.host}})()))(e,t),{capture:!0,passive:!0}),W[t]={},!0),addListener:(t,e,s)=>{const o=W[t][e]||[];return o.indexOf(s)<0&&o.push(s),W[t][e]=o,!0},removeListener:(t,e,s)=>{const o=W[t][e]||[],r=o.indexOf(s);return r>=0&&o.splice(r,1),W[t][e]=o,!0},trigger:(t,e,s)=>{t.dispatchEvent(new window.Event(e,Object.assign({bubbles:!0,composed:!0},s)))}};let q={elements:{}};return q.Element=k,q.Parser=x,q.makeEqual=u,q.Loader=j,q.SimpleElement=P,q.Event=H,q.register=function(t){t.useShadowRoot=q.config.useShadowRoot;const e=t.elementName;if(e)if(window.customElements.get(e))window.console.warn(`Error creating Element: ${e} - Custom Element with this name is already defined.`);else if(e.indexOf("-")<1)window.console.warn(`Error creating Element: ${e} - Custom Element name must have one dash '-'`);else try{return window.customElements.define(e,t),q.elements[e]=t,!0}catch(t){return window.console.warn(`Error creating Custom Element: ${e} - ${t}`),!1}else window.console.warn("Error creating Custom Element: No name given.",t);return!1},q.setup=function(t){q.config=Object.assign({baseUrl:"/",useShadowRoot:!0},t),q.Event.add("input"),q.Event.add("change"),q.Event.addListener("change","document",q.Parser.twoWayBind),q.Event.addListener("input","document",q.Parser.twoWayBind)},q.load=function(t,e={baseUrl:q.config.baseUrl}){return new Promise(s=>{new q.Loader(t,e).executeScripts().then(()=>s())})},q.Url=t,q.Json=s,q.relativeTo=function(t,e){if("string"==typeof t)return q.Url.absolute(q.Loader.urls[t],e)},q});
/*! (c) @aadityataparia */
//# sourceMappingURL=sifrr.dom.min.js.map
