/*! Sifrr.Dom v0.0.1-alpha - sifrr project - 2018/12/20 16:22:43 UTC */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t.Sifrr=t.Sifrr||{},t.Sifrr.Dom=e())}(this,function(){"use strict";var t={updateAttribute:function(t,e,n){t.hasAttribute(e)?t.getAttribute(e)!==n&&("null"!==n&&"undefined"!==n&&"false"!==n&&n?t.setAttribute(e,n):t.removeAttribute(e)):t.setAttribute(e,n);"SELECT"==t.nodeName&&"value"==e&&(t.value=n)}};const{updateAttribute:e}=t;function n(t,e){if(Array.isArray(e)||(e=Array.prototype.slice.call(e)),0===e.length)return void(t.textContent="");let n=t.childNodes.length;if(n>e.length){let r,s=n,o=t.lastChild;for(;s>e.length;)r=o.previousSibling,t.removeChild(o),o=r,s--}let s=t.firstChild;for(let n,o=0;o<e.length;o++)n=e[o],!s&&n?t.appendChild(n):s=r(s,n).nextSibling}function r(t,r){if(null===r)return t;if("stateChange"===r.type)return t.state!==r.state&&(t.state=r.state),t;if(t.nodeName!==r.nodeName)return t.replaceWith(r),r;if(t.nodeType===window.Node.TEXT_NODE||t.nodeType===window.Node.COMMENT_NODE)return t.nodeValue!==r.nodeValue&&(t.nodeValue=r.nodeValue),t;t.state=r.state;let s,o=t.attributes,a=r.attributes;for(var i=a.length-1;i>=0;--i){const n=(s=a[i]).name,r=s.value;e(t,n,r)}for(var l=o.length-1;l>=0;--l)if(!1!==(s=o[l]).specified){const e=s.name;r.hasAttribute(e)||t.removeAttribute(e)}return n(t,r.childNodes),t}var s={makeEqual:r,makeChildrenEqual:n};const o=window.document.createTreeWalker(document,NodeFilter.SHOW_ALL,null,!1);o.roll=function(t,e=!1){let n=this.currentNode;for(;--t;)n=e&&e(n)?o.nextSibling()||o.parentNode():o.nextNode();return n};class a{constructor(t,e){this.idx=t,this.ref=e}}var i={walker:o,collect:function(t,e=t.stateMap,n){const r=[];return o.currentNode=t,e.map(t=>r.push({dom:o.roll(t.idx,n),data:t.ref})),r},create:function(t,e,n=!1){let r,s=[],i=0;for(o.currentNode=t;t;)(r=e(t))?(s.push(new a(i+1,r)),i=1):i++,t=n&&n(t)?o.nextSibling()||o.parentNode():o.nextNode();return s},klass:a};const{makeChildrenEqual:l}=s,{updateAttribute:c}=t,u=window.document.createElement("sifrr-node"),d=3,h=8,f=1;function p(t){return t.dataset&&"true"==t.dataset.sifrrHtml||"true"==t.contentEditable||"TEXTAREA"==t.nodeName||"STYLE"==t.nodeName}function m(t){if(t.nodeType===d){const e=t.nodeValue;if(e.indexOf("${")>-1)return{html:!1,text:e}}else{if(t.nodeType===h&&"$"==t.nodeValue.trim()[0])return{html:!1,text:t.nodeValue.trim()};if(t.nodeType===f){const e={};p(t)&&(e.html=!0,e.text=t.innerHTML.replace(/<!--(.*)-->/g,"$1"));const n=t.attributes||[],r=n.length,s={};for(let t=0;t<r;t++){const e=n[t];e.value.indexOf("${")>-1&&(s[e.name]=e.value)}if(Object.keys(s).length>0&&(e.attributes=s),Object.keys(e).length>0)return e}}return 0}const g={collectRefs:(t,e)=>i.collect(t,e,p),createStateMap:function(t){let e;return e=t.useShadowRoot?t.shadowRoot:t,i.create(e,m,p)},twoWayBind:function(t){const e=t.path?t.path[0]:t.target;if(!e.dataset.sifrrBind)return;const n=void 0===e.value?e.innerHTML:e.value;let r={};r[e.dataset.sifrrBind]=n,e.getRootNode().host.state=r},updateState:function(t){if(!t._refs)return!1;const e=t._refs.length;for(let n=0;n<e;n++){const e=t._refs[n];if(e.data.attributes)for(let n in e.data.attributes){const r=g.evaluateString(e.data.attributes[n],t);c(e.dom,n,r)}if(void 0===e.data.html)return;const r=e.dom.innerHTML,s=g.evaluateString(e.data.text,t);if(r==s)return;if(void 0===s)return e.dom.textContent="";if(e.data.html){let t;if(Array.isArray(s))t=s;else if(s.nodeType)t=[s];else{const e=u.cloneNode();e.innerHTML=s.toString().replace(/&amp;/g,"&").replace(/&nbsp;/g," ").replace(/(&lt;)(((?!&gt;).)*)(&gt;)(((?!&lt;).)*)(&lt;)\/(((?!&gt;).)*)(&gt;)/g,"<$2>$5</$8>").replace(/(&lt;)(input|link|img|br|hr|col|keygen)(((?!&gt;).)*)(&gt;)/g,"<$2$3>"),t=e.childNodes}t.length<1?e.dom.textContent="":l(e.dom,t)}else e.dom.nodeValue!=s&&(e.dom.nodeValue=s)}"function"==typeof this.onStateUpdate&&this.onStateUpdate()},evaluateString:function(t,e){return t.indexOf("${")<0?t:(t=t.trim()).match(/^\${([^{}$]|{([^{}$])*})*}$/)?n(t):n("`"+t+"`");function n(t){let n;return"$"==t[0]&&(t=t.slice(2,-1)),(n=t.search("return")>=0?new Function(t).bind(e):new Function("return "+t).bind(e))()}}};var w=g;class y{static parse(t){let e={};if("string"==typeof t){try{e=JSON.parse(t)}catch(e){return t}return this.parse(e)}if(Array.isArray(t))e=[],t.forEach((t,n)=>{e[n]=this.parse(t)});else{if("object"!=typeof t)return t;for(const n in t)e[n]=this.parse(t[n])}return e}static stringify(t){return"string"==typeof t?t:JSON.stringify(t)}static shallowEqual(t,e){for(let n in t)if(!(n in e)||t[n]!=e[n])return!1;for(let n in e)if(!(n in t)||t[n]!=e[n])return!1;return!0}static deepClone(t){if(Array.isArray(t))return t.map(t=>y.deepClone(t));if("object"!=typeof t||null===t)return t;let e={};for(let n in t)e[n]=y.deepClone(t[n]);return e}}var b=y;"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var S,v=(function(t,e){var n;t.exports=(n=class{constructor(t,e,n){this.type=t,this._options=n,this._url=e}get response(){return window.fetch(this.url,this.options).then(t=>{let e=t.headers.get("content-type");if(e&&e.includes("application/json")&&(t=t.json()),t.ok)return t;{let e=Error(t.statusText);throw e.response=t,e}})}get url(){let t=delete this._options.params;return t&&Object.keys(t).length>0?this._url+"?"+Object.keys(t).map(e=>encodeURIComponent(e)+"="+encodeURIComponent(t[e])).join("&"):this._url}get options(){return Object.assign(this._options,{method:this.type,headers:Object.assign({accept:"application/json"},this._options.headers||{}),mode:"cors",redirect:"follow"})}},class{static get(t,e={}){return new n("GET",t,e).response}static post(t,e={}){return new n("POST",t,e).response}static put(t,e={}){return new n("PUT",t,e).response}static delete(t,e={}){return new n("DELETE",t,e).response}static file(t,e={}){return e.headers=e.headers||{},e.headers.accept=e.headers.accept||"*/*",new n("GET",t,e).response}})}(S={exports:{}},S.exports),S.exports);class _{constructor(t,e={}){if(this.constructor.all[t])return this.constructor.all[t];this.elementName=t,this.config=e}get html(){const t=this;return v.file(this.htmlUrl).then(t=>t.text()).then(t=>(new window.DOMParser).parseFromString(t,"text/html")).then(e=>(_.add(t.elementName,e.querySelector("template")),e))}get htmlUrl(){return this.config.url||`${this.config.baseUrl||"/"}elements/${this.elementName.split("-").join("/")}.html`}executeScripts(){return this.html.then(t=>{t.querySelectorAll("script").forEach(t=>{new Function(t.text).bind(window)()})})}static add(t,e){_._all[t]=e}static get all(){return _._all}}_._all={};var E=_;const{collect:A,create:C}=i,N=document.createElement("template");function x(t){if(3!==t.nodeType){if(void 0!==t.attributes){const e=Array.from(t.attributes),n=e.length,r=[];for(let t=0;t<n;t++){const n=e[t].value;"$"===n[0]&&r.push({name:e[t].name,text:n.slice(2,-1)})}if(r.length>0)return r}return 0}{let e=t.nodeValue;return"$"===e[0]?(t.nodeValue="",e.slice(2,-1)):0}}function T(t){const e=t._refs,n=e.length,r=t.state,s=t._oldState;for(let t=0;t<n;t++){const n=e[t].data,o=e[t].dom;if(Array.isArray(n)){const t=n.length;for(let e=0;e<t;e++){const t=n[e];s[t.text]!=r[t.text]&&o.setAttribute(t.name,r[t.text])}}else s[n]!=r[n]&&(o.nodeValue=r[n])}}var $=function(t,e){return"string"==typeof t&&(N.innerHTML=t,t=N.content.firstChild),t.stateMap=C(t,x),t._refs=A(t,t.stateMap),Object.defineProperty(t,"state",{get:()=>t._state,set:e=>{t._oldState=Object.assign({},t._state),t._state=Object.assign(t._state||{},e),T(t)}}),e&&(t.state=e),t.sifrrClone=function(n){const r=t.cloneNode(n);return r._refs=A(r,t.stateMap),Object.defineProperty(r,"state",{get:()=>r._state,set:t=>{r._oldState=Object.assign({},r._state),r._state=Object.assign(r._state||{},t),T(r)}}),e&&(r.state=e),r},t};var O=class extends window.HTMLElement{static get observedAttributes(){return["data-sifrr-state"].concat(this.observedAttrs())}static observedAttrs(){return[]}static get template(){return E.all[this.elementName]}static get stateMap(){return this._stateMap=this._stateMap||w.createStateMap(this.template.content),this._stateMap}static get elementName(){return this.name.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}constructor(){super(),this._state=Object.assign({},this.constructor.defaultState,b.parse(this.dataset.sifrrState),this.state);const t=this.constructor.template.content.cloneNode(!0);this._refs=w.collectRefs(t,this.constructor.stateMap),this.useShadowRoot="false"!==this.constructor.template.dataset.noShadowRoot&&this.constructor.useShadowRoot,this.useShadowRoot?(this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(t),this.shadowRoot.addEventListener("change",w.twoWayBind)):this.appendChild(t)}connectedCallback(){w.updateState(this),this.onConnect()}onConnect(){}disconnectedCallback(){this.useShadowRoot?this.shadowRoot.removeEventListener("change",w.twoWayBind):this.removeEventListener("change",w.twoWayBind),this.onDisconnect()}onDisconnect(){}attributeChangedCallback(t,e,n){"data-sifrr-state"===t&&(this.state=b.parse(n)),this.onAttributeChange()}onAttributeChange(){}get state(){return this._state}set state(t){this._oldState=this.state,Object.assign(this._state,t),w.updateState(this)}isSifrr(t=null){return!t||t==this.constructor.elementName}clearState(){this._state={},w.updateState(this)}srqs(t){return this.shadowRoot.querySelector(t)}srqsAll(t){return this.shadowRoot.querySelectorAll(t)}static addArrayToDom(t,e){this._arrayToDom=this._arrayToDom||{},this._arrayToDom[t]=$(e)}arrayToDom(t,e=this.state[t]){this._domL=this._domL||{};const n=this._domL[t],r=[],s=e.length;if(n)for(let o=0;o<s;o++)if(o<n)r.push({type:"stateChange",state:e[o]});else{const n=this.constructor._arrayToDom[t].clone();n.state=e[o],r.push(n)}else for(let n=0;n<s;n++){const s=this.constructor._arrayToDom[t].sifrrClone(!0);s.state=e[n],r.push(s)}return this._domL[t]=s,r}};const j=(t,e)=>{let n=t.path?t.path[0]:t.target;for(;n;){const t=n[`$${e}`];t&&t(event,e),n=n.parentNode||n.host}},L={};let R={elements:{}};return R.Element=O,R.Parser=w,R.makeEqual=s,R.Loader=E,R.register=function(t){t.useShadowRoot=R.config.useShadowRoot;const e=t.elementName;if(e)if(window.customElements.get(e))window.console.warn(`Error creating Element: ${e} - Custom Element with this name is already defined.`);else if(e.indexOf("-")<1)window.console.warn(`Error creating Element: ${e} - Custom Element name must have one dash '-'`);else try{return window.customElements.define(e,t),R.elements[e]=t,!0}catch(t){return window.console.warn(`Error creating Custom Element: ${e} - ${t}`),!1}else window.console.warn("Error creating Custom Element: No name given.",t);return!1},R.addEvent=(t=>!L[t]&&(window.document.addEventListener(t,e=>j(e,t),{capture:!0,passive:!0}),L[t]=!0,!0)),R.setup=function(t){R.config=Object.assign({baseUrl:"/",useShadowRoot:!0},t),R.addEvent("input"),R.addEvent("change"),window.document.$input=R.Parser.twoWayBind,window.document.$change=R.Parser.twoWayBind},R.SimpleElement=$,R.load=function(t,e={baseUrl:R.config.baseUrl}){new R.Loader(t,e).executeScripts()},R});
/*! (c) @aadityataparia */
