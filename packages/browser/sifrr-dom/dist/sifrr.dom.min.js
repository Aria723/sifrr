/*! Sifrr.Dom v0.0.1-alpha - sifrr project - 2018/12/26 3:18:44 UTC */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t.Sifrr=t.Sifrr||{},t.Sifrr.Dom=e())}(this,function(){"use strict";var t={absolute:(t,e)=>{let n=t.split("/"),r=e.split("/");n.pop();for(let t=0;t<r.length;t++)"."!=r[t]&&(".."==r[t]?n.pop():n.push(r[t]));return n.join("/")},getRoutes:t=>{"/"!=t[0]&&(t="/"+t);let e=t.indexOf("?");return-1!=e&&(t=t.substring(0,e)),t.split("/")}};var e={updateAttribute:function(t,e,n){if("class"===e)t.className!=n&&(t.className="null"!=n&&"undefined"!=n&&"false"!=n&&n?n:"");else{const r=t.getAttribute(e);r!=n&&("null"!=n&&"undefined"!=n&&"false"!=n&&n?t.setAttribute(e,n):r&&t.removeAttribute(e)),"SELECT"==t.nodeName&&"value"==e&&(t.value=n)}}};const n={parse:t=>{let e={};if("string"==typeof t){try{e=JSON.parse(t)}catch(e){return t}return n.parse(e)}if(Array.isArray(t))e=[],t.forEach((t,r)=>{e[r]=n.parse(t)});else{if("object"!=typeof t)return t;for(const r in t)e[r]=n.parse(t[r])}return e},stringify:t=>"string"==typeof t?t:JSON.stringify(t),shallowEqual:(t,e)=>{for(let n in t)if(!(n in e)||t[n]!=e[n])return!1;for(let n in e)if(!(n in t)||t[n]!=e[n])return!1;return!0},deepClone:t=>{if(Array.isArray(t))return t.map(t=>n.deepClone(t));if("object"!=typeof t||null===t)return t;let e={};for(let r in t)e[r]=n.deepClone(t[r]);return e}};var r=n,s={SIFRR_NODE:window.document.createElement("template"),TEXT_NODE:3,COMMENT_NODE:8,ELEMENT_NODE:1};const{updateAttribute:o}=e,{shallowEqual:a}=r,{TEXT_NODE:i,COMMENT_NODE:l}=s;function c(t,e){const n=t.childNodes.length,r=e.length;if(n>r){let e=n;for(;e>r;)t.removeChild(t.lastChild),e--}else if(n<r){let s=n;for(;s<r;)t.appendChild(e[s]),s++}const s=Math.min(r,n);for(let n,r=0,o=t.firstChild;r<s;r++)o=u(o,n=e[r]).nextSibling}function u(t,e){if(null===e)return t;if("stateChange"===e.type)return a(t.state,e.state)||(t.state=e.state),t;if(t.nodeName!==e.nodeName)return t.replaceWith(e),e;if(t.nodeType===i||t.nodeType===l)return t.data!==e.data&&(t.data=e.data),t;e.state&&(t.state=e.state);let n,r=t.attributes,s=e.attributes;for(let e=s.length-1;e>=0;--e)o(t,s[e].name,s[e].value);for(let s=r.length-1;s>=0;--s)n=r[s],e.hasAttribute(n.name)||!1===n.specified||t.removeAttribute(n.name);return c(t,e.childNodes),t}var d={makeEqual:u,makeChildrenEqual:c};const h=window.document.createTreeWalker(document,NodeFilter.SHOW_ALL,null,!1);h.roll=function(t,e=!1){let n=this.currentNode;for(;--t;)n=e&&e(n)?h.nextSibling()||h.parentNode():h.nextNode();return n};class f{constructor(t,e){this.idx=t,this.ref=e}}var p={walker:h,collect:function(t,e=t.stateMap,n){const r=[];return h.currentNode=t,e.map(t=>r.push(h.roll(t.idx,n))),r},create:function(t,e,n=!1){let r,s=[],o=0;for(h.currentNode=t;t;)(r=e(t))?(s.push(new f(o+1,r)),o=1):o++,t=n&&n(t)?h.nextSibling()||h.parentNode():h.nextNode();return s},klass:f};const{makeChildrenEqual:m}=d,{updateAttribute:g}=e,{collect:w,create:b}=p,{SIFRR_NODE:E,TEXT_NODE:y,COMMENT_NODE:S,ELEMENT_NODE:_}=s;function N(t){return t.dataset&&"true"==t.dataset.sifrrHtml||"true"==t.contentEditable||"TEXTAREA"==t.nodeName||"STYLE"==t.nodeName||t.dataset&&t.dataset.sifrrRepeat}function v(t){if(t.nodeType===y){const e=t.nodeValue;if(e.indexOf("${")>-1)return{html:!1,text:e}}else{if(t.nodeType===S&&"$"==t.nodeValue.trim()[0])return{html:!1,text:t.nodeValue.trim()};if(t.nodeType===_){const e={};if(N(t)){const n=t.innerHTML;n.indexOf("${")>=0&&(e.html=!0,e.text=n.replace(/<!--(.*)-->/g,"$1"))}const n=t.attributes||[],r=n.length,s={};for(let t=0;t<r;t++){const e=n[t];e.value.indexOf("${")>=0&&(s[e.name]=e.value)}if(Object.keys(s).length>0&&(e.attributes=s),Object.keys(e).length>0)return e}}return 0}const O={collectRefs:(t,e)=>w(t,e,N),createStateMap:t=>{let e;return e=t.useShadowRoot?t.shadowRoot:t,b(e,v,N)},updateState:t=>{if(!t._refs)return!1;const e=t._refs.length;for(let n=0;n<e;n++){const e=t.constructor.stateMap[n].ref,r=t._refs[n];if(e.attributes)for(let n in e.attributes){const s=O.evaluateString(e.attributes[n],t);g(r,n,s)}if(void 0===e.html)continue;const s=O.evaluateString(e.text,t);if(s)if(e.html){let t;if(Array.isArray(s))t=s;else if(s.nodeType)t=[s];else{const e=E.cloneNode();e.innerHTML=s.toString().replace(/(&lt;)(((?!&gt;).)*)(&gt;)(((?!&lt;).)*)(&lt;)\/(((?!&gt;).)*)(&gt;)/g,"<$2>$5</$8>").replace(/(&lt;)(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)(((?!&gt;).)*)(&gt;)/g,"<$2$3>"),t=Array.prototype.slice.call(e.childNodes)}t.length<1?r.textContent="":m(r,t)}else r.nodeValue!=s&&(r.nodeValue=s);else r.textContent=""}t.onStateChange(t.state)},twoWayBind:t=>{const e=t.path?t.path[0]:t.target;if(!e.dataset.sifrrBind)return;const n=void 0===e.value?e.innerHTML:e.value;let r={};r[e.dataset.sifrrBind]=n,e.getRootNode().host.state=r},evaluateString:(t,e)=>{return t.indexOf("${")<0?t:(t=t.trim()).match(/^\${([^{}$]|{([^{}$])*})*}$/)?n(t):n("`"+t+"`");function n(t){let n;return"$"==t[0]&&(t=t.slice(2,-1)),(n=t.indexOf("return ")>=0?new Function(t).bind(e):new Function("return "+t).bind(e))()}}};var T=O;"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var C,x=(function(t,e){var n;t.exports=(n=class{constructor(t,e,n){this.type=t,this._options=n,this._url=e}get response(){return window.fetch(this.url,this.options).then(t=>{let e=t.headers.get("content-type");if(e&&e.includes("application/json")&&(t=t.json()),t.ok)return t;{let e=Error(t.statusText);throw e.response=t,e}})}get url(){let t=delete this._options.params;return t&&Object.keys(t).length>0?this._url+"?"+Object.keys(t).map(e=>encodeURIComponent(e)+"="+encodeURIComponent(t[e])).join("&"):this._url}get options(){return Object.assign(this._options,{method:this.type,headers:Object.assign({accept:"application/json"},this._options.headers||{}),mode:"cors",redirect:"follow"})}},class{static get(t,e={}){return new n("GET",t,e).response}static post(t,e={}){return new n("POST",t,e).response}static put(t,e={}){return new n("PUT",t,e).response}static delete(t,e={}){return new n("DELETE",t,e).response}static file(t,e={}){return e.headers=e.headers||{},e.headers.accept=e.headers.accept||"*/*",new n("GET",t,e).response}})}(C={exports:{}},C.exports),C.exports);class A{constructor(t,e={}){if(this.constructor.all[t])return this.constructor.all[t];this.elementName=t,this.config=e,this.constructor.urls[t]=this.htmlUrl}get html(){const t=this;return x.file(this.htmlUrl).then(t=>t.text()).then(t=>(new window.DOMParser).parseFromString(t,"text/html")).then(e=>(A.add(t.elementName,e.querySelector("template")),e))}get htmlUrl(){return this.config.url||`${this.config.baseUrl||"/"}elements/${this.elementName.split("-").join("/")}.html`}executeScripts(){return this.html.then(t=>{t.querySelectorAll("script").forEach(t=>{new Function(t.text).bind(window)()})})}static add(t,e){A._all[t]=e}static get all(){return A._all}}A._all={},A.urls={};var M=A;const{collect:R,create:$}=p,{SIFRR_NODE:L}=s;function j(t){if(3!==t.nodeType){if(void 0!==t.attributes){const e=Array.from(t.attributes),n=e.length,r=[];for(let t=0;t<n;t++){const n=e[t].value;"$"===n[0]&&r.push({name:e[t].name,text:n.slice(2,-1)})}if(r.length>0)return r}return 0}{let e=t.nodeValue;return"$"===e[0]?(t.nodeValue="",e.slice(2,-1)):0}}function D(t){const e=t._refs,n=t.stateMap,r=n.length,s=t.state,o=t._oldState;for(let t=0;t<r;t++){const r=n[t].ref,a=e[t];if(Array.isArray(r)){const t=r.length;for(let e=0;e<t;e++){const t=r[e];o[t.text]!==s[t.text]&&("class"===t.name?a.className=s[t.text]||"":a.setAttribute(t.name,s[t.text]))}}else o[r]!=s[r]&&(a.nodeValue=s[r])}}var k=function(t,e){return"string"==typeof t&&(L.innerHTML=t,t=L.content.firstElementChild||L.content.firstChild),t.isSifrr&&t.isSifrr()?t:(t.stateMap=$(t,j),t._refs=R(t,t.stateMap),Object.defineProperty(t,"state",{get:()=>t._state,set:e=>{t._oldState=Object.assign({},t._state),t._state=Object.assign(t._state||{},e),D(t)}}),e&&(t.state=e),t.sifrrClone=function(e){const n=t.cloneNode(e);return n.stateMap=t.stateMap,n._refs=R(n,t.stateMap),Object.defineProperty(n,"state",{get:()=>n._state,set:t=>{n._oldState=Object.assign({},n._state),n._state=Object.assign(n._state||{},t),D(n)}}),t.state&&(n.state=t.state),n},t)};var q=class extends window.HTMLElement{static get observedAttributes(){return["data-sifrr-state"].concat(this.observedAttrs())}static observedAttrs(){return[]}static get template(){return M.all[this.elementName]}static get stateMap(){return this._stateMap=this._stateMap||T.createStateMap(this.template.content),this._stateMap}static get elementName(){return this.name.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}constructor(){super(),this._state=Object.assign({},this.constructor.defaultState,this.state);const t=this.constructor.template.content.cloneNode(!0);this._refs=T.collectRefs(t,this.constructor.stateMap),this.useShadowRoot="false"!==this.constructor.template.dataset.sr&&!!window.document.head.attachShadow&&this.constructor.useShadowRoot,this.useShadowRoot?(this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(t),this.shadowRoot.addEventListener("change",T.twoWayBind)):this.appendChild(t)}connectedCallback(){this.hasAttribute("data-sifrr-state")||T.updateState(this),this.onConnect()}onConnect(){}disconnectedCallback(){this.useShadowRoot&&this.shadowRoot.removeEventListener("change",T.twoWayBind),this.onDisconnect()}onDisconnect(){}attributeChangedCallback(t,e,n){"data-sifrr-state"===t&&(this.state=r.parse(n)),this.onAttributeChange()}onAttributeChange(){}get state(){return this._state}set state(t){Object.assign(this._state,t),T.updateState(this)}onStateChange(){}isSifrr(t=null){return!t||t===this.constructor.elementName}sifrrClone(t){const e=this.cloneNode(t);return e.state=this.state,e}clearState(){this._state={},T.updateState(this)}qs(t,e=!0){return this.useShadowRoot&&e?this.shadowRoot.querySelector(t):this.querySelector(t)}qsAll(t,e=!0){return this.useShadowRoot&&e?this.shadowRoot.querySelectorAll(t):this.querySelectorAll(t)}static addArrayToDom(t,e){this._arrayToDom=this._arrayToDom||{},this._arrayToDom[t]=k(e)}arrayToDom(t,e=this.state[t]){this._domL=this._domL||{};const n=this._domL[t]||0,r=[],s=e.length;for(let o=0;o<s;o++)if(o<n)r.push({type:"stateChange",state:e[o]});else{const n=this.constructor._arrayToDom[t].sifrrClone(!0);n.state=e[o],r.push(n)}return this._domL[t]=s,r}};const P={},U=(t,e,n)=>{function r(e){e.forEach(e=>e(t))}for(let t in P[e])("function"==typeof n.matches&&n.matches(t)||9===n.nodeType&&"document"===t)&&r(P[e][t])};var F={add:t=>!P[t]&&(window.document.addEventListener(t,e=>((t,e)=>Promise.resolve((()=>{let n=t.path?t.path[0]:t.target;for(;n;){const r=n[`$${e}`];r&&r(t),U(t,e,n),n=n.parentNode||n.host}})()))(e,t),{capture:!0,passive:!0}),P[t]={},!0),addListener:(t,e,n)=>{const r=P[t][e]||[];return r.indexOf(n)<0&&r.push(n),P[t][e]=r,!0},removeListener:(t,e,n)=>{const r=P[t][e]||[],s=r.indexOf(n);return s>=0&&r.splice(s,1),P[t][e]=r,!0},trigger:(t,e,n)=>{t.dispatchEvent(new window.Event(e,Object.assign({bubbles:!0,composed:!0},n)))}};let V={elements:{}};return V.Element=q,V.Parser=T,V.makeEqual=d,V.Loader=M,V.SimpleElement=k,V.Event=F,V.register=function(t){t.useShadowRoot=V.config.useShadowRoot;const e=t.elementName;if(e)if(window.customElements.get(e))window.console.warn(`Error creating Element: ${e} - Custom Element with this name is already defined.`);else if(e.indexOf("-")<1)window.console.warn(`Error creating Element: ${e} - Custom Element name must have one dash '-'`);else try{return window.customElements.define(e,t),V.elements[e]=t,!0}catch(t){return window.console.warn(`Error creating Custom Element: ${e} - ${t}`),!1}else window.console.warn("Error creating Custom Element: No name given.",t);return!1},V.setup=function(t){V.config=Object.assign({baseUrl:"/",useShadowRoot:!0},t),V.Event.add("input"),V.Event.add("change"),V.Event.addListener("change","document",V.Parser.twoWayBind),V.Event.addListener("input","document",V.Parser.twoWayBind)},V.load=function(t,e={baseUrl:V.config.baseUrl}){return new Promise(n=>{new V.Loader(t,e).executeScripts().then(()=>n())})},V.relativeTo=function(e,n){if("string"==typeof e)return t.absolute(V.Loader.urls[e],n)},V});
/*! (c) @aadityataparia */
//# sourceMappingURL=sifrr.dom.min.js.map
