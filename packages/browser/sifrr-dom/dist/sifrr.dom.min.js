/*! Sifrr.Dom v0.0.1-alpha2 - sifrr project */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@sifrr/fetch")):"function"==typeof define&&define.amd?define(["@sifrr/fetch"],e):(t.Sifrr=t.Sifrr||{},t.Sifrr.Dom=e(t.Sifrr.Fetch))}(this,function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e={absolute:(t,e)=>{let s=t.split("/"),r=e.split("/");s.pop();for(let t=0;t<r.length;t++)"."!=r[t]&&(".."==r[t]?s.pop():s.push(r[t]));return s.join("/")},getRoutes:t=>{"/"!=t[0]&&(t="/"+t);let e=t.indexOf("?");return-1!=e&&(t=t.substring(0,e)),t.split("/")}};const s={parse:t=>{let e={};if("string"==typeof t){try{e=JSON.parse(t)}catch(e){return t}return s.parse(e)}if(Array.isArray(t))e=[],t.forEach((t,r)=>{e[r]=s.parse(t)});else{if("object"!=typeof t)return t;for(const r in t)e[r]=s.parse(t[r])}return e},stringify:t=>"string"==typeof t?t:JSON.stringify(t),shallowEqual:(t,e)=>{for(let s in t)if(!(s in e)||t[s]!=e[s])return!1;for(let s in e)if(!(s in t)||t[s]!=e[s])return!1;return!0},deepClone:t=>{if(Array.isArray(t))return t.map(t=>s.deepClone(t));if("object"!=typeof t||null===t)return t;let e={};for(let r in t)e[r]=s.deepClone(t[r]);return e}};var r=s,o={SIFRR_NODE:window.document.createElement("sifrr-node"),TEMPLATE:window.document.createElement("template"),TEXT_NODE:3,COMMENT_NODE:8,ELEMENT_NODE:1};var n={updateAttribute:function(t,e,s){if("class"===e)t.className!=s&&(t.className="null"!=s&&"undefined"!=s&&"false"!=s&&s?s:"");else{const r=t.getAttribute(e);r!=s&&("null"!=s&&"undefined"!=s&&"false"!=s&&s?t.setAttribute(e,s):r&&t.removeAttribute(e)),"SELECT"!=t.nodeName&&"INPUT"!=t.nodeName||"value"!=e||(t.value=s)}}};const{updateAttribute:i}=n,{shallowEqual:a}=r,{TEXT_NODE:c,COMMENT_NODE:l}=o;function u(t,e){const s=t.childNodes.length,r=e.length;if(s>r){let e=s;for(;e>r;)t.removeChild(t.lastChild),e--}else if(s<r){let o=s;for(;o<r;)t.appendChild(e[o]),o++}const o=Math.min(r,s);for(let s,r=0,n=t.firstChild;r<o;r++)n=f(n,s=e[r]).nextSibling}function f(t,e){if(null===e)return t;if("stateChange"===e.type)return a(t.state,e.state)||(t.state=e.state),t;if(t.nodeName!==e.nodeName)return t.replaceWith(e),e;if(t.nodeType===c||t.nodeType===l)return t.data!==e.data&&(t.data=e.data),t;e.state&&(t.state=e.state);let s,r=t.attributes,o=e.attributes;for(let e=o.length-1;e>=0;--e)i(t,o[e].name,o[e].value);for(let o=r.length-1;o>=0;--o)s=r[o],e.hasAttribute(s.name)||!1===s.specified||t.removeAttribute(s.name);return u(t,e.childNodes),t}var h={makeEqual:f,makeChildrenEqual:u};const d=window.document.createTreeWalker(document,NodeFilter.SHOW_ALL,null,!1);d.roll=function(t,e=!1){let s=this.currentNode;for(;--t;)s=e&&e(s)?d.nextSibling()||d.parentNode():d.nextNode();return s};class p{constructor(t,e){this.idx=t,this.ref=e}}var g={walker:d,collect:function(t,e=t.stateMap,s){const r=[];return d.currentNode=t,e.map(t=>r.push(d.roll(t.idx,s))),r},create:function(t,e,s=!1){let r,o=[],n=0;for(d.currentNode=t;t;)(r=e(t))?(o.push(new p(n+1,r)),n=1):n++,t=s&&s(t)?d.nextSibling()||d.parentNode():d.nextNode();return o},Ref:p};const{makeChildrenEqual:m}=h,{updateAttribute:b}=n,{collect:y,create:N}=g,{TEMPLATE:_,TEXT_NODE:v,COMMENT_NODE:S,ELEMENT_NODE:O}=o;function C(t){return t.dataset&&"true"==t.dataset.sifrrHtml||"true"==t.contentEditable||"TEXTAREA"==t.nodeName||"STYLE"==t.nodeName||t.dataset&&t.dataset.sifrrRepeat}function x(t){if(t.nodeType===v||t.nodeType===S){const e=t.nodeValue;if(e.indexOf("${")>-1)return{html:!1,text:e.trim()}}else if(t.nodeType===O){const e={};if(C(t)){const s=t.innerHTML;s.indexOf("${")>=0&&(e.html=!0,e.text=s.replace(/<!--(.*)-->/g,"$1"))}const s=t.attributes||[],r=s.length,o={events:{}};for(let t=0;t<r;t++){const e=s[t];"$"===e.name[0]?o.events[e.name]=e.value:e.value.indexOf("${")>=0&&(o[e.name]=e.value)}if(Object.keys(o).length>0&&(e.attributes=o),Object.keys(e).length>0)return e}return 0}const E={collectRefs:(t,e)=>y(t,e,C),createStateMap:t=>N(t,x,C),update:t=>{if(!t._refs)return!1;const e=t._refs.length;for(let s=0;s<e;s++){const e=t.constructor.stateMap[s].ref,r=t._refs[s];if(e.attributes)for(let s in e.attributes)if("events"===s)for(let s in e.attributes.events)r[s]=E.evaluateString(e.attributes.events[s],t);else{const o=E.evaluateString(e.attributes[s],t);b(r,s,o)}if(void 0===e.html)continue;const o=E.evaluateString(e.text,t);if(o)if(e.html){let t;Array.isArray(o)?t=o:o.nodeType?t=[o]:(_.innerHTML=o.toString().replace(/(&lt;)(((?!&gt;).)*)(&gt;)(((?!&lt;).)*)(&lt;)\/(((?!&gt;).)*)(&gt;)/g,"<$2>$5</$8>").replace(/(&lt;)(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)(((?!&gt;).)*)(&gt;)/g,"<$2$3>"),t=Array.prototype.slice.call(_.content.childNodes)),t.length<1?r.textContent="":m(r,t)}else r.nodeValue!=o&&(r.nodeValue=o);else r.textContent=""}},twoWayBind:t=>{const e=t.path?t.path[0]:t.target;if(!e.dataset.sifrrBind)return;const s=void 0===e.value?e.innerHTML:e.value;let r,o={};if(e._root)r=e._root;else{for(r=e;!r.isSifrr;)r=r.parentNode||r.host;e._root=r}o[e.dataset.sifrrBind]=s,r.state=o},evaluateString:(t,e)=>{return t.indexOf("${")<0?t:(t=t.trim()).match(/^\${([^{}$]|{([^{}$])*})*}$/)?s(t):s("`"+t+"`");function s(t){let s;return"$"==t[0]&&(t=t.slice(2,-1)),(s=t.indexOf("return ")>=0?new Function(t).bind(e):new Function("return "+t).bind(e))()}}};var $=E;const{TEMPLATE:j}=o;class R{constructor(e,s={}){if(!t)throw Error("Sifrr.Dom.load requires Sifrr.Fetch to work.");if(this.constructor.all[e])return this.constructor.all[e].instance;this.elementName=e,this.config=s,this.constructor.urls[e]=this.htmlUrl}get html(){const e=this;if(this.constructor.all[this.elementName]&&this.constructor.all[this.elementName].html)return this.constructor.all[this.elementName].html;const s=t.file(this.htmlUrl).then(t=>t.text()).then(t=>(j.innerHTML=t,j.content)).then(t=>(R._all[e.elementName].template=t.querySelector("template"),t));return R.add(e.elementName,{instance:e,html:s}),s}get js(){if(this.constructor.all[this.elementName]&&this.constructor.all[this.elementName].js)return this.constructor.all[this.elementName].js;const e=t.file(this.jsUrl).then(t=>t.text());return R.add(this.elementName,{instance:this,js:e}),e}get htmlUrl(){return this.config.url||`${this.config.baseUrl||""}/elements/${this.elementName.split("-").join("/")}.html`}get jsUrl(){return this.config.url||`${this.config.baseUrl||""}/elements/${this.elementName.split("-").join("/")}.js`}executeScripts(){return this.html.then(t=>{t.querySelectorAll("script").forEach(t=>{t.hasAttribute("src")?window.document.body.appendChild(t):new Function(t.text).bind(window)()})}).catch(t=>{window.console.warn(t),window.console.log("Trying to get js file."),this.js.then(t=>{new Function(t).bind(window)()})})}static add(t,e){R._all[t]=Object.assign(R._all[t]||{},e)}static get all(){return R._all}}R._all={},R.urls={};var A=R;const{collect:M,create:T}=g,{TEMPLATE:D}=o;function L(t){if(3!==t.nodeType){if(void 0!==t.attributes){const e=Array.from(t.attributes),s=e.length,r=[];for(let t=0;t<s;t++){const s=e[t].value;"$"===s[0]&&r.push({name:e[t].name,text:s.slice(2,-1)})}if(r.length>0)return r}return 0}{let e=t.nodeValue;return"$"===e[0]?(t.nodeValue="",e.slice(2,-1)):0}}function U(t){const e=t._refs,s=t.stateMap,r=s.length,o=t.state,n=t._oldState;for(let t=0;t<r;t++){const r=s[t].ref,i=e[t];if(Array.isArray(r)){const t=r.length;for(let e=0;e<t;e++){const t=r[e];n[t.text]!==o[t.text]&&("class"===t.name?i.className=o[t.text]||"":i.setAttribute(t.name,o[t.text]))}}else n[r]!=o[r]&&(i.nodeValue=o[r])}}var w=function(t,e){if("string"==typeof t){D.innerHTML=t;const e=(t=D.content.firstElementChild||D.content.firstChild).style.display;t.style.display="none",window.document.body.appendChild(t),t.remove(),t.style.display=e}return-1!==t.nodeName.indexOf("-")||t.getAttribute("is")&&t.getAttribute("is").indexOf("-")>=0||t.isSifrr&&t.isSifrr()?t:(t.stateMap=T(t,L),t._refs=M(t,t.stateMap),Object.defineProperty(t,"state",{get:()=>t._state,set:e=>{t._oldState=Object.assign({},t._state),t._state=Object.assign(t._state||{},e),U(t)}}),e&&(t.state=e),t.sifrrClone=function(e){const s=t.cloneNode(e);return s.stateMap=t.stateMap,s._refs=M(s,t.stateMap),Object.defineProperty(s,"state",{get:()=>s._state,set:t=>{s._oldState=Object.assign({},s._state),s._state=Object.assign(s._state||{},t),U(s)}}),t.state&&(s.state=t.state),s},t)};var H=function t(e){return class extends e{static extends(e){return t(e)}static get observedAttributes(){return["data-sifrr-state"].concat(this.observedAttrs())}static observedAttrs(){return[]}static get template(){return A.all[this.elementName].template}static get stateMap(){return this._stateMap=this._stateMap||$.createStateMap(this.template.content),this._stateMap}static get elementName(){return this.name.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}static onStateChange(){}static get useShadowRoot(){return"false"!==this.template.getAttribute("use-shadow-root")&&this.useSR}constructor(){super(),(this.constructor.defaultState||this.state)&&(this._state=Object.assign({},this.constructor.defaultState,this.state));const t=this.constructor.template.content.cloneNode(!0);this.constructor.useShadowRoot?(this._refs=$.collectRefs(t,this.constructor.stateMap),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(t),this.shadowRoot.addEventListener("change",$.twoWayBind)):this.__content=t}connectedCallback(){this.constructor.useShadowRoot?!this.hasAttribute("data-sifrr-state")&&this._state&&this.update():(this._refs=$.collectRefs(this.__content,this.constructor.stateMap),this.appendChild(this.__content),this._state&&this.update()),this.onConnect()}onConnect(){}disconnectedCallback(){this.shadowRoot&&this.shadowRoot.removeEventListener("change",$.twoWayBind),this.constructor.useShadowRoot||(this.textContent=""),this.onDisconnect()}onDisconnect(){}attributeChangedCallback(t,e,s){"data-sifrr-state"===t&&(this.state=r.parse(s)),this.onAttributeChange(t,e,s)}onAttributeChange(){}get state(){return this._state}set state(t){this._state=this._state||{},Object.assign(this._state,t),this.update()}update(){$.update(this),this.onStateChange(),this.constructor.onStateChange(this)}onStateChange(){}isSifrr(t=null){return!t||t===this.constructor.elementName}sifrrClone(t){return this.cloneNode(t)}clearState(){this._state={},this.update()}$(t,e=!0){return this.constructor.useShadowRoot&&e?this.shadowRoot.querySelector(t):this.querySelector(t)}$$(t,e=!0){return this.constructor.useShadowRoot&&e?this.shadowRoot.querySelectorAll(t):this.querySelectorAll(t)}static addArrayToDom(t,e){this._arrayToDom=this._arrayToDom||{},this._arrayToDom[this.elementName]=this._arrayToDom[this.elementName]||{},this._arrayToDom[this.elementName][t]=w(e)}arrayToDom(t,e=this.state[t]){this._domL=this._domL||{};const s=this._domL[t]||0,r=[],o=e.length;let n;try{n=this.constructor._arrayToDom[this.constructor.elementName][t]}catch(e){return window.console.log(`[error]: No arrayToDom data of '${t}' added in ${this.constructor.elementName}.`)}for(let t=0;t<o;t++)if(t<s)r.push({type:"stateChange",state:e[t]});else{const s=n.sifrrClone(!0);s.state=e[t],r.push(s)}return this._domL[t]=o,r}}}(window.HTMLElement);const F={},W=(t,e,s)=>{function r(e){e.forEach(e=>e(t,s))}for(let t in F[e])("function"==typeof s.matches&&s.matches(t)||9===s.nodeType&&"document"===t)&&r(F[e][t])};var B={add:t=>!F[t]&&(window.document.addEventListener(t,e=>((t,e)=>Promise.resolve((()=>{let s=t.path?t.path[0]:t.target;for(;s;){const r=s[`$${e}`];r&&r(t,s),W(t,e,s),s=s.parentNode||s.host}})()))(e,t),{capture:!0,passive:!0}),F[t]={},!0),addListener:(t,e,s)=>{const r=F[t][e]||[];return r.indexOf(s)<0&&r.push(s),F[t][e]=r,!0},removeListener:(t,e,s)=>{const r=F[t][e]||[],o=r.indexOf(s);return o>=0&&r.splice(o,1),F[t][e]=r,!0},trigger:(t,e,s)=>{t.dispatchEvent(new window.Event(e,Object.assign({bubbles:!0,composed:!0},s)))}};const{TEMPLATE:k}=o;let q={elements:{}};return q.Element=H,q.Parser=$,q.makeEqual=h,q.Loader=A,q.SimpleElement=w,q.Event=B,q.html=((t,...e)=>(t=String.raw(t,...e).replace(/{{(.*)}}/g,"${$1}"),k.innerHTML=t,k)),q.register=((t,e)=>{t.useSR=q.config.useShadowRoot;const s=t.elementName;if(s)if(window.customElements.get(s))window.console.warn(`Error creating Element: ${s} - Custom Element with this name is already defined.`);else if(s.indexOf("-")<1)window.console.error(`Error creating Element: ${s} - Custom Element name must have one dash '-'`);else try{return window.customElements.define(s,t,e),q.elements[s]=t,!0}catch(t){return window.console.error(`Error creating Custom Element: ${s} - ${t}`),!1}else window.console.error("Error creating Custom Element: No name given.",t);return!1}),q.setup=function(t){q.config=Object.assign({baseUrl:"",useShadowRoot:!0},t),q.Event.add("input"),q.Event.add("change"),q.Event.addListener("change","document",q.Parser.twoWayBind),q.Event.addListener("input","document",q.Parser.twoWayBind)},q.load=function(t,e={baseUrl:q.config.baseUrl}){return new q.Loader(t,e).executeScripts()},q.Url=e,q.Json=r,q.relativeTo=function(t,e){if("string"==typeof t)return q.Url.absolute(q.Loader.urls[t],e)},q});
/*! (c) @aadityataparia */
//# sourceMappingURL=sifrr.dom.min.js.map
