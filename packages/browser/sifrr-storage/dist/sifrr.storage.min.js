/*! Sifrr.Storage v0.0.1-alpha2 - sifrr project */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e.Sifrr=e.Sifrr||{},e.Sifrr.Storage=t())}(this,function(){"use strict";var e=class{static parse(e){let t={};if("string"==typeof e){try{t=JSON.parse(e)}catch(t){return e}return this.parse(t)}if(Array.isArray(e))t=[],e.forEach((e,r)=>{t[r]=this.parse(e)});else{if("object"!=typeof e)return e;for(const r in e)t[r]=this.parse(e[r])}return t}static stringify(e){return"string"==typeof e?e:JSON.stringify(e)}};var t=class{constructor(e){this._options=e}_parseKeyValue(e,t){let r={}.constructor;if(void 0===t){if(Array.isArray(e))return e;if("string"==typeof e)return[e];if(e.constructor===r)return e;throw Error("Invalid Key")}if("string"==typeof e){let r={};return r[e]=t,r}throw Error("Invalid Key")}_select(e){return this.data().then(t=>{let r={};return e.forEach(e=>r[e]=t[e]),r})}_upsert(e){let t=this.table;for(let r in e)t[r]=e[r];this.table=t}_delete(e){let t=this.table;e.forEach(e=>delete t[e]),this.table=t}_clear(){this.table={}}_isEqual(e,t){return this.tableName==e.name+e.version&&this.type==t}get tableName(){return this.name+this.version}get name(){return this._options.name}get version(){return this._options.version}get description(){return this._options.description}get type(){return this.constructor.type}isSupported(){return"undefined"==typeof window||"undefined"==typeof document||!(!window||void 0===this.store)}all(){return this.data()}data(){return Promise.resolve(this._parsedData())}select(e){return Promise.resolve(this._select(this._parseKeyValue(e)))}insert(e,t){return Promise.resolve(this._upsert(this._parseKeyValue(e,t)))}update(e,t){return Promise.resolve(this._upsert(this._parseKeyValue(e,t)))}upsert(e,t){return Promise.resolve(this._upsert(this._parseKeyValue(e,t)))}delete(e){return Promise.resolve(this._delete(this._parseKeyValue(e)))}deleteAll(){return Promise.resolve(this._clear())}clear(){return Promise.resolve(this._clear())}static stringify(t){return e.stringify(t)}static parse(t){return e.parse(t)}};var r=class extends t{constructor(e){super(e)}_parsedData(){return this._tx("readonly","getAll").then(e=>this.parse(e))}_select(e){let t={},r=[];return e.forEach(e=>r.push(this._tx("readonly","get",e).then(r=>t[e]=this.parse(r)))),Promise.all(r).then(()=>t)}_upsert(e){let t=[];for(let r in e){let s=this._tx("readonly","get",r).then(t=>t&&t.key==r?this._tx("readwrite","put",{key:r,value:e[r]}):this._tx("readwrite","add",{key:r,value:e[r]}));t.push(s)}return Promise.all(t)}_delete(e){let t=[];return e.forEach(e=>t.push(this._tx("readwrite","delete",e))),Promise.all(t)}_clear(){return this._tx("readwrite","clear")}_tx(e,t,r){let s=this;return this.createStore(s.tableName).then(i=>new Promise((o,a)=>{let n=i.transaction(s.tableName,e).objectStore(s.tableName),l=n[t].call(n,r);l.onsuccess=(e=>o(e.target.result)),l.onerror=(e=>a(e.error))}))}get store(){return window.indexedDB}createStore(e){return new Promise((t,r)=>{const s=this.store.open(e,1);s.onupgradeneeded=(t=>{t.target.result.createObjectStore(e,{keyPath:"key"})}),s.onsuccess=(()=>t(s.result)),s.onerror=(()=>r(s.error))})}parse(e){let t={};return Array.isArray(e)?(e.forEach(e=>{t[e.key]=e.value}),t):e&&e.value?e.value:void 0}static get type(){return"indexeddb"}};var s=class extends t{constructor(e){super(e),this.createStore()}_parsedData(){let e=this;return new Promise(t=>{this.store.transaction(function(r){r.executeSql(`SELECT * FROM ${e.tableName}`,[],(r,s)=>{t(e.parse(s))})})})}_select(e){let t=e.map(()=>"?").join(", ");return this.execSql(`SELECT key, value FROM ${this.tableName} WHERE key in (${t})`,e)}_upsert(e){let t=this.tableName;this.store.transaction(r=>{for(let s in e)r.executeSql(`INSERT OR IGNORE INTO ${t}(key, value) VALUES (?, ?)`,[s,e[s]]),r.executeSql(`UPDATE ${t} SET value = ? WHERE key = ?`,[this.constructor.stringify(e[s]),s])})}_delete(e){let t=this.tableName,r=e.map(()=>"?").join(", ");return this.execSql(`DELETE FROM ${t} WHERE key in (${r})`,e)}_clear(){let e=this.tableName;return this.execSql(`DELETE FROM ${e}`)}get store(){return"undefined"==typeof window||window.openDatabase("bs",1,this._options.description,this._options.size)}createStore(){let e=this.tableName;if("undefined"!=typeof window)return this.execSql(`CREATE TABLE IF NOT EXISTS ${e} (key unique, value)`)}execSql(e,t=[]){let r=this;return new Promise(s=>{r.store.transaction(function(i){i.executeSql(e,t,(e,t)=>{s(r.parse(t))})})})}parse(e){let t,r={},s=e.rows.length;for(t=0;t<s;t++)r[e.rows.item(t).key]=this.constructor.parse(e.rows.item(t).value);return r}static get type(){return"websql"}};var i=class extends t{constructor(e){super(e)}_parsedData(){return this.table}get table(){return this.constructor.parse(this.store.getItem(this.tableName))}set table(e){this.store.setItem(this.tableName,this.constructor.stringify(e))}get store(){return window.localStorage}static get type(){return"localstorage"}};var o=class extends t{constructor(e){super(e)}_parsedData(){return this.table}get table(){let e=this.store,t={};return e.split("; ").forEach(e=>{let[r,s]=e.split("=");s&&(t[r]=this.constructor.parse(s))}),t[this.tableName]||{}}set table(e){document.cookie=`${this.tableName}=${t.stringify(e)}; path=/`}get store(){return document.cookie}static get type(){return"cookies"}};var a=class extends t{constructor(e,t={}){super(e),this._upsert(this.constructor.parse(t))}_parsedData(){return this._table}get store(){return this._table}get table(){return this._table||{}}set table(e){this._table=e}static get type(){return"jsonstorage"}};let n={};n[r.type]=r,n[s.type]=s,n[i.type]=i,n[o.type]=o,n[a.type]=a;var l=n;return class{constructor(e){return e="string"==typeof e?{priority:[e]}:e||{},this._options=Object.assign(this.constructor.defaultOptions,e),this.storage}get storage(){let e=this.supportedStore();if(void 0===e)throw new Error("No available storage supported in this browser");let t=this.constructor._matchingInstance(this._options,e.type);if(t)return t;{let t=new e(this._options);return this.constructor._add(t),t}}get priority(){return this._options.priority.concat(["indexeddb","websql","localstorage","cookies","jsonstorage"])}supportedStore(){for(let e=0;e<this.priority.length;e++){let t=this.constructor.availableStores[this.priority[e]];if(t&&new t(this._options).isSupported())return t}}static _matchingInstance(e,t){let r,s=this.all,i=s.length;for(r=0;r<i;r++)if(s[r]._isEqual(e,t))return s[r];return!1}static _add(e){this._all=this._all||[],this._all.push(e)}static get availableStores(){return l}static get defaultOptions(){return{priority:[],name:"SifrrStorage",version:1,description:"Sifrr Storage",size:5242880}}static get all(){return this._all||[]}static json(e){return new a({},e)}}});
/*! (c) @aadityataparia */
//# sourceMappingURL=sifrr.storage.min.js.map
