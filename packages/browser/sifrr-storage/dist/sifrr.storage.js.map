{"version":3,"file":"sifrr.storage.js","sources":["../src/utils/json.js","../src/storages/storage.js","../src/storages/indexeddb.js","../src/storages/websql.js","../src/storages/localstorage.js","../src/storages/cookies.js","../src/storages/jsonstorage.js","../src/storages.js","../src/sifrr.storage.js"],"sourcesContent":["class Json {\n  static parse(data) {\n    let ans = data;\n    if (typeof data == 'string') {\n      try {\n        return this.parse(JSON.parse(data));\n      } catch(e) {\n        return data;\n      }\n    } else if (Array.isArray(data)) {\n      ans = [];\n      data.forEach((v, i) => {\n        ans[i] = this.parse(v);\n      });\n    } else if (typeof data == 'object') {\n      if (data === null) return null;\n      ans = {};\n      for (const k in data) {\n        ans[k] = this.parse(data[k]);\n      }\n    }\n    return ans;\n  }\n\n  static stringify(data) {\n    if (typeof data == 'string') {\n      return data;\n    } else {\n      return JSON.stringify(data);\n    }\n  }\n}\n\nmodule.exports = Json;\n","const JsonExt = require('../utils/json');\nconst jsonConstructor = {}.constructor;\n\nclass Storage {\n  constructor(options = {}) {\n    this._options = options;\n  }\n\n  _parseKeyValue(key, value) {\n    if (typeof value === 'undefined') {\n      if (Array.isArray(key)) {\n        return key;\n      } else if (typeof key === 'string') {\n        return [key];\n      } else if (key.constructor === jsonConstructor) {\n        return key;\n      } {\n        throw Error('Invalid Key');\n      }\n    } else if (typeof key === 'string') {\n      let ans = {};\n      ans[key] = value;\n      return ans;\n    } else {\n      throw Error('Invalid Key');\n    }\n  }\n\n  _select(keys) {\n    return this.all().then((data) => {\n      let ans = {};\n      keys.forEach((key) => ans[key] = data[key]);\n      return ans;\n    });\n  }\n\n  _upsert(data) {\n    let table = this.table;\n    for (let key in data) {\n      table[key] = data[key];\n    }\n    this.table = table;\n  }\n\n  _delete(keys) {\n    let table = this.table;\n    keys.forEach((key) => delete table[key]);\n    this.table = table;\n  }\n\n  _clear() {\n    this.table = {};\n  }\n\n  _isEqual(options, type) {\n    if (this.tableName == options.name + options.version && this.type == type) { return true; }\n    else { return false; }\n  }\n\n  get tableName() {\n    return this.name + this.version;\n  }\n\n  get name() {\n    return this._options.name;\n  }\n\n  get version() {\n    return this._options.version;\n  }\n\n  get description() {\n    return this._options.description;\n  }\n\n  get type() {\n    return this.constructor.type;\n  }\n\n  isSupported(force = true) {\n    if (force && (typeof window === 'undefined' || typeof document === 'undefined')) { return true; }\n    else if (window && typeof this.store !== 'undefined') { return true; }\n    else { return false; }\n  }\n\n  keys() {\n    return this.all().then(d => Object.keys(d));\n  }\n\n  all() {\n    return Promise.resolve(this._parsedData());\n  }\n\n  get(key) {\n    return Promise.resolve(this._select(this._parseKeyValue(key)));\n  }\n\n  set(key, value) {\n    return Promise.resolve(this._upsert(this._parseKeyValue(key, value)));\n  }\n\n  del(key) {\n    return Promise.resolve(this._delete(this._parseKeyValue(key)));\n  }\n\n  clear() {\n    return Promise.resolve(this._clear());\n  }\n\n  static stringify(data) {\n    return JsonExt.stringify(data);\n  }\n\n  static parse(data) {\n    return JsonExt.parse(data);\n  }\n}\n\nmodule.exports = Storage;\n","const Storage = require('./storage');\n\nclass IndexedDB extends Storage {\n  constructor(options) {\n    super(options);\n  }\n\n  _parsedData() {\n    return this._tx('readonly', 'getAll').then((result) => this.parse(result));\n  }\n\n  _select(keys) {\n    const ans = {};\n    const promises = [];\n    keys.forEach((key) => promises.push(this._tx('readonly', 'get', key).then((r) => ans[key] = this.parse(r))));\n    return Promise.all(promises).then(() => ans);\n  }\n\n  _upsert(data) {\n    const promises = [];\n    for (let key in data) {\n      const promise = this._tx('readonly', 'get', key).then((oldResult) => {\n        if (oldResult && oldResult.key == key) {\n          return this._tx('readwrite', 'put', { key: key, value: data[key] });\n        } else {\n          return this._tx('readwrite', 'add', { key: key, value: data[key] });\n        }\n      });\n      promises.push(promise);\n    }\n    return Promise.all(promises);\n  }\n\n  _delete(keys) {\n    const promises = [];\n    keys.forEach((key) => promises.push(this._tx('readwrite', 'delete', key)));\n    return Promise.all(promises);\n  }\n\n  _clear() {\n    return this._tx('readwrite', 'clear');\n  }\n\n  _tx(scope, fn, params) {\n    const me = this;\n    this._store = this._store || this.createStore(me.tableName);\n    return this._store.then((db) => {\n      return new Promise((resolve, reject) => {\n        const tx = db.transaction(me.tableName, scope).objectStore(me.tableName);\n        const request = tx[fn].call(tx, params);\n        request.onsuccess = (event) =>  resolve(event.target.result);\n        request.onerror = (event) => reject(event.error);\n      });\n    });\n  }\n\n  get store() {\n    return window.indexedDB;\n  }\n\n  createStore(table) {\n    return new Promise((resolve, reject) => {\n      const request = this.store.open(table, 1);\n      request.onupgradeneeded = (event) => {\n        const db = event.target.result;\n        db.createObjectStore(table, { keyPath: 'key' });\n      };\n      request.onsuccess = () => resolve(request.result);\n      request.onerror = () => reject(request.error);\n    });\n  }\n\n  parse(data) {\n    const ans = {};\n    if (Array.isArray(data)) {\n      data.forEach((row) => {\n        ans[row.key] = row.value;\n      });\n    } else if (data && data.value !== 'undefined') {\n      return data.value;\n    } else {\n      return undefined;\n    }\n    return ans;\n  }\n\n  static get type() {\n    return 'indexeddb';\n  }\n}\n\nmodule.exports = IndexedDB;\n","const Storage = require('./storage');\n\nclass WebSQL extends Storage {\n  constructor(options) {\n    super(options);\n    this.createStore();\n  }\n\n  _parsedData() {\n    const me = this;\n    return new Promise((resolve) => {\n      this.store.transaction(function (tx) {\n        tx.executeSql(`SELECT * FROM ${me.tableName}`, [], (txn, results) => {\n          resolve(me.parse(results));\n        });\n      });\n    });\n  }\n\n  _select(keys) {\n    const me = this;\n    const q = keys.map(() => '?').join(', ');\n    // Need to give array for ? values in executeSql's 2nd argument\n    return this.execSql(`SELECT key, value FROM ${me.tableName} WHERE key in (${q})`, keys);\n  }\n\n  _upsert(data) {\n    const table = this.tableName;\n    this.store.transaction((tx) => {\n      for (let key in data) {\n        tx.executeSql(`INSERT OR IGNORE INTO ${table}(key, value) VALUES (?, ?)`, [key, data[key]]);\n        tx.executeSql(`UPDATE ${table} SET value = ? WHERE key = ?`, [this.constructor.stringify(data[key]), key]);\n      }\n    });\n  }\n\n  _delete(keys) {\n    const table = this.tableName;\n    const q = keys.map(() => '?').join(', ');\n    return this.execSql(`DELETE FROM ${table} WHERE key in (${q})`, keys);\n  }\n\n  _clear() {\n    const table = this.tableName;\n    return this.execSql(`DELETE FROM ${table}`);\n  }\n\n  get store() {\n    return window.openDatabase('bs', 1, this._options.description, this._options.size);\n  }\n\n  createStore() {\n    const table = this.tableName;\n    if (!window || typeof window.openDatabase !== 'function') return;\n    return this.execSql(`CREATE TABLE IF NOT EXISTS ${table} (key unique, value)`);\n  }\n\n  execSql(query, args = []) {\n    const me = this;\n    return new Promise((resolve) => {\n      me.store.transaction(function (tx) {\n        tx.executeSql(query, args, (txn, results) => {\n          resolve(me.parse(results));\n        });\n      });\n    });\n  }\n\n  parse(results) {\n    const ans = {};\n    const len = results.rows.length;\n    for (let i = 0; i < len; i++) {\n      ans[results.rows.item(i).key] = this.constructor.parse(results.rows.item(i).value);\n    }\n    return ans;\n  }\n\n  static get type() {\n    return 'websql';\n  }\n}\n\nmodule.exports = WebSQL;\n","const Storage = require('./storage');\n\nclass LocalStorage extends Storage {\n  constructor(options) {\n    super(options);\n  }\n\n  _parsedData() {\n    return this.table;\n  }\n\n  get table() {\n    return this.constructor.parse(this.store.getItem(this.tableName) || {});\n  }\n\n  set table(value) {\n    this.store.setItem(this.tableName, this.constructor.stringify(value));\n  }\n\n  get store() {\n    return window.localStorage;\n  }\n\n  static get type() {\n    return 'localstorage';\n  }\n}\n\nmodule.exports = LocalStorage;\n","const Storage = require('./storage');\n\nclass Cookies extends Storage {\n  constructor(options) {\n    super(options);\n  }\n\n  _parsedData() {\n    return this.table;\n  }\n\n  get table() {\n    let result = this.store, ans = {};\n    result.split('; ').forEach((value) => {\n      let [k, v] = value.split('=');\n      ans[k] = this.constructor.parse(v);\n    });\n    return ans[this.tableName] || {};\n  }\n\n  set table(value) {\n    document.cookie = `${this.tableName}=${Storage.stringify(value)}; path=/`;\n  }\n\n  get store() {\n    return document.cookie;\n  }\n\n  static get type() {\n    return 'cookies';\n  }\n}\n\nmodule.exports = Cookies;\n","const Storage = require('./storage');\n\nclass JsonStorage extends Storage {\n  constructor(options, data = {}) {\n    super(options);\n    this.table = Storage.parse(data);\n  }\n\n  _parsedData() {\n    return this.table;\n  }\n\n  _upsert(data) {\n    for (let key in data) {\n      this.table[key] = data[key];\n    }\n  }\n\n  get store() {\n    return this.table;\n  }\n\n  static get type() {\n    return 'jsonstorage';\n  }\n}\n\nmodule.exports = JsonStorage;\n","const IndexedDB = require('./storages/indexeddb');\nconst WebSQL = require('./storages/websql');\nconst LocalStorage = require('./storages/localstorage');\nconst Cookies = require('./storages/cookies');\nconst JsonStorage = require('./storages/jsonstorage');\n\nlet storages = {};\nstorages[IndexedDB.type] = IndexedDB;\nstorages[WebSQL.type] = WebSQL;\nstorages[LocalStorage.type] = LocalStorage;\nstorages[Cookies.type] = Cookies;\nstorages[JsonStorage.type] = JsonStorage;\n\nmodule.exports = storages;\n","const storages = require('./storages');\nconst JsonStorage = require('./storages/jsonstorage');\n\nclass SifrrStorage {\n  constructor(options) {\n    if (typeof options === 'string') options = { priority: [options] }; else options = options || {};\n    this._options = Object.assign(this.constructor.defaultOptions, options);\n    return this.storage;\n  }\n\n  get storage() {\n    let storage = this.supportedStore();\n    if (typeof storage === 'undefined') throw Error('No available storage supported in this browser');\n    let matchingInstance = this.constructor._matchingInstance(this._options, storage.type);\n    if (matchingInstance) { return matchingInstance; }\n    else {\n      let storageInstance = new storage(this._options);\n      this.constructor._add(storageInstance);\n      return storageInstance;\n    }\n  }\n\n  get priority() {\n    return this._options.priority.concat(['indexeddb', 'websql', 'localstorage', 'cookies', 'jsonstorage']);\n  }\n\n  supportedStore() {\n    for (let i = 0; i < this.priority.length; i++) {\n      let store = this.constructor.availableStores[this.priority[i]];\n      if (store && new store(this._options).isSupported()) return store;\n    }\n  }\n\n  static _matchingInstance(options, type) {\n    let allInstances = this.all, i;\n    let length = allInstances.length;\n    for (i = 0; i < length; i++) {\n      if (allInstances[i]._isEqual(options, type)) return allInstances[i];\n    }\n    return false;\n  }\n\n  static _add(instance) {\n    this.all.push(instance);\n  }\n\n  static get defaultOptions() {\n    return {\n      priority: [],\n      name: 'SifrrStorage',\n      version: 1,\n      description: 'Sifrr Storage',\n      size: 5 * 1024 * 1024\n    };\n  }\n\n  static json(data) {\n    return new JsonStorage({}, data);\n  }\n}\n\nSifrrStorage.availableStores = storages;\nSifrrStorage.all = [];\n\nmodule.exports = SifrrStorage;\n"],"names":["Json","parse","data","ans","JSON","e","Array","isArray","forEach","v","i","k","stringify","jsonConstructor","constructor","Storage","options","_options","_parseKeyValue","key","value","Error","_select","keys","all","then","_upsert","table","_delete","_clear","_isEqual","type","tableName","name","version","description","isSupported","force","window","document","store","d","Object","Promise","resolve","_parsedData","get","set","del","clear","JsonExt","IndexedDB","_tx","result","promises","push","r","promise","oldResult","scope","fn","params","me","_store","createStore","db","reject","tx","transaction","objectStore","request","call","onsuccess","event","target","onerror","error","indexedDB","open","onupgradeneeded","createObjectStore","keyPath","row","undefined","WebSQL","executeSql","txn","results","q","map","join","execSql","openDatabase","size","query","args","len","rows","length","item","LocalStorage","getItem","setItem","localStorage","Cookies","split","cookie","JsonStorage","storages","SifrrStorage","priority","assign","defaultOptions","storage","supportedStore","matchingInstance","_matchingInstance","storageInstance","_add","concat","availableStores","allInstances","instance","json"],"mappings":"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"}