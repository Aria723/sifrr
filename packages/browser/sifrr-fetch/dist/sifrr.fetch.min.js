/*! Sifrr.Fetch v0.0.3 - sifrr project | MIT licensed | https://github.com/sifrr/sifrr */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e=e||self).Sifrr=e.Sifrr||{},e.Sifrr.Fetch=t())}(this,function(){"use strict";var e=class{constructor(e,t){this._options=t,this._url=e}get response(){const e=this;return window.fetch(this.url,this.options).then(t=>{const s=t.headers.get("content-type"),r=s&&s.includes("application/json");if(t.ok&&"function"==typeof e._options.onProgress){const s=t.headers.get("content-length"),r=parseInt(s,10);if(r&&t.body&&ReadableStream){const s=t.body.getReader();let o=0;t=new Response(new ReadableStream({start:t=>(function n(){return s.read().then(({done:s,value:i})=>{if(!s)return o+=i.byteLength,e._options.onProgress(o/r*100),t.enqueue(i),n();e._options.onProgress(100),t.close()})})()}))}else e._options.onProgress(100)}else if(!t.ok){"function"==typeof e._options.onProgress&&e._options.onProgress(100);let s=Error(t.statusText);throw s.response=t,s}return{response:t,isJson:r}}).then(({response:e,isJson:t})=>t?e.json():e)}get url(){const e=this._options.params;return e&&Object.keys(e).length>0?this._url+"?"+Object.keys(e).map(t=>encodeURIComponent(t)+"="+encodeURIComponent(e[t])).join("&"):this._url}get options(){const e=Object.assign({redirect:"follow"},this._options);return e.headers=Object.assign({accept:"application/json"},this._options.headers||{}),e.body&&e.body.constructor==={}.constructor&&(e.headers["content-type"]=e.headers["content-type"]||"application/json",e.body=JSON.stringify(e.body)),e}};function t(e,t,s,r,o,n,i){try{var a=e[n](i),c=a.value}catch(e){return void s(e)}a.done?t(c):Promise.resolve(c).then(r,o)}var s=class{constructor(e,t,s=(()=>Promise.reject(Error("No fallback provided for websocket failure.")))){this.url=e,this.protocol=t,this._fallback=!window.WebSocket,this.fallback=s,this.id=1,this._requests={},this._openSocket()}send(e,t){return e.constructor==={}.constructor?this.sendJSON(e,t):this.sendRaw(e,this.id++)}sendJSON(e,t="JSON"){const s={};return s.sifrrQueryType=t,s.sifrrQueryId=this.id++,s.data=e,this.sendRaw(JSON.stringify(s),s.sifrrQueryId,e)}sendRaw(e,s,r=e){var o,n=this;return(o=function*(){return n._fallback?n.fallback(r):(yield n._openSocket())?(n.ws.send(e),new Promise(e=>{n._requests[s]={res:t=>{delete n._requests[s],e(t)},original:r}})):n.fallback(r)},function(){var e=this,s=arguments;return new Promise(function(r,n){var i=o.apply(e,s);function a(e){t(i,r,n,a,c,"next",e)}function c(e){t(i,r,n,a,c,"throw",e)}a(void 0)})})()}_openSocket(){if(this.ws){if(this.ws.readyState===this.ws.OPEN)return Promise.resolve(!0);if(this.ws.readyState!==this.ws.CONNECTING)return this.ws=null,this._openSocket()}else this.ws=new window.WebSocket(this.url,this.protocol),this.ws.onopen=this.onopen.bind(this),this.ws.onerror=this.onerror.bind(this),this.ws.onclose=this.onclose.bind(this),this.ws.onmessage=this._onmessage.bind(this);const e=this;return new Promise(t=>{window.requestAnimationFrame(function s(){e.ws.readyState===e.ws.CONNECTING?window.requestAnimationFrame(s):e.ws.readyState!==e.ws.OPEN?(window.console.error("Failed to open socket on ".concat(e.url)),t(!1)):t(!0)})})}onerror(){this._fallback=!!this.fallback;for(let e in this._requests){const t=this._requests[e];this.fallback(t.data).then(e=>t.res(e))}}onopen(){}onclose(){}close(){this.ws.close()}_onmessage(e){const t=JSON.parse(e.data);t.sifrrQueryId&&this._requests[t.sifrrQueryId].res(t.data),delete this._requests[t.sifrrQueryId],this.onmessage(e)}onmessage(){}};class r{static get(e,t){return this.request(e,t,"GET")}static post(e,t){return this.request(e,t,"POST")}static put(e,t){return this.request(e,t,"PUT")}static delete(e,t){return this.request(e,t,"DELETE")}static graphql(e,t={}){const{query:s,variables:r={}}=t;return delete t.query,delete t.variables,t.headers=t.headers||{},t.headers["Content-Type"]="application/json",t.headers.Accept="application/json",t.body={query:s,variables:r},this.request(e,t,"POST")}static socket(e,t,r){return new s(e,t,r?e=>{const t={},s=r.method.toLowerCase();return t.headers=t.headers||{},t.headers["content-type"]=t.headers["content-type"]||"application/json","post"===s?t.body=e:t.query=e,this[s](r.url,t)}:void 0)}static file(e,t={}){return t.headers=t.headers||{},t.headers.accept=t.headers.accept||"*/*",this.request(e,t,"GET")}static request(t,s={},r){const{url:o,options:n}=this.afterUse(t,s,r);return new e(o,n).response}static use(e){r._middlewares.push(e)}static afterUse(e,t={},s){return t.method=(t.method||s).toUpperCase(),r._middlewares.forEach(s=>{const r=s(e,t);e=r.url,t=r.options}),{url:e,options:t}}}return r._middlewares=[],r.WebSocket=s,r});
/*! (c) @aadityataparia */
