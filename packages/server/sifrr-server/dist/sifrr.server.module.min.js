/*! Sifrr.Server v0.0.4 - sifrr project | MIT licensed | https://github.com/sifrr/sifrr */
import t from"uWebSockets.js";import e from"fs";import i from"path";import a from"stream";import o from"zlib";import n from"busboy";import r from"mkdirp";var s={writeHeaders:function(t,e,i){if(void 0!==i)t.writeHeader(e,i.toString());else for(let i in e)t.writeHeader(i,e[i].toString())},extend:function(t,e,i=!0){Object.getOwnPropertyNames(e.prototype).forEach(a=>{"constructor"!==a&&(t[a]&&i&&(t[`_${a}`]=t[a]),"function"==typeof e.prototype[a]?t[a]=e.prototype[a].bind(t):t[a]=function(t){return"object"==typeof t?Array.isArray(t)?t.slice(0):null===t?null:Object.assign({},t):t}(e.prototype[a]))})}};const p={"3gp":"video/3gpp",a:"application/octet-stream",ai:"application/postscript",aif:"audio/x-aiff",aiff:"audio/x-aiff",asc:"application/pgp-signature",asf:"video/x-ms-asf",asm:"text/x-asm",asx:"video/x-ms-asf",atom:"application/atom+xml",au:"audio/basic",avi:"video/x-msvideo",bat:"application/x-msdownload",bin:"application/octet-stream",bmp:"image/bmp",bz2:"application/x-bzip2",c:"text/x-c",cab:"application/vnd.ms-cab-compressed",cc:"text/x-c",chm:"application/vnd.ms-htmlhelp",class:"application/octet-stream",com:"application/x-msdownload",conf:"text/plain",cpp:"text/x-c",crt:"application/x-x509-ca-cert",css:"text/css",csv:"text/csv",cxx:"text/x-c",deb:"application/x-debian-package",der:"application/x-x509-ca-cert",diff:"text/x-diff",djv:"image/vnd.djvu",djvu:"image/vnd.djvu",dll:"application/x-msdownload",dmg:"application/octet-stream",doc:"application/msword",dot:"application/msword",dtd:"application/xml-dtd",dvi:"application/x-dvi",ear:"application/java-archive",eml:"message/rfc822",eps:"application/postscript",exe:"application/x-msdownload",f:"text/x-fortran",f77:"text/x-fortran",f90:"text/x-fortran",flv:"video/x-flv",for:"text/x-fortran",gem:"application/octet-stream",gemspec:"text/x-script.ruby",gif:"image/gif",gz:"application/x-gzip",h:"text/x-c",hh:"text/x-c",htm:"text/html",html:"text/html",ico:"image/vnd.microsoft.icon",ics:"text/calendar",ifb:"text/calendar",iso:"application/octet-stream",jar:"application/java-archive",java:"text/x-java-source",jnlp:"application/x-java-jnlp-file",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/javascript",json:"application/json",log:"text/plain",m3u:"audio/x-mpegurl",m4v:"video/mp4",man:"text/troff",mathml:"application/mathml+xml",mbox:"application/mbox",mdoc:"text/troff",me:"text/troff",mid:"audio/midi",midi:"audio/midi",mime:"message/rfc822",mjs:"application/javascript",mml:"application/mathml+xml",mng:"video/x-mng",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mp4v:"video/mp4",mpeg:"video/mpeg",mpg:"video/mpeg",ms:"text/troff",msi:"application/x-msdownload",odp:"application/vnd.oasis.opendocument.presentation",ods:"application/vnd.oasis.opendocument.spreadsheet",odt:"application/vnd.oasis.opendocument.text",ogg:"application/ogg",p:"text/x-pascal",pas:"text/x-pascal",pbm:"image/x-portable-bitmap",pdf:"application/pdf",pem:"application/x-x509-ca-cert",pgm:"image/x-portable-graymap",pgp:"application/pgp-encrypted",pkg:"application/octet-stream",pl:"text/x-script.perl",pm:"text/x-script.perl-module",png:"image/png",pnm:"image/x-portable-anymap",ppm:"image/x-portable-pixmap",pps:"application/vnd.ms-powerpoint",ppt:"application/vnd.ms-powerpoint",ps:"application/postscript",psd:"image/vnd.adobe.photoshop",py:"text/x-script.python",qt:"video/quicktime",ra:"audio/x-pn-realaudio",rake:"text/x-script.ruby",ram:"audio/x-pn-realaudio",rar:"application/x-rar-compressed",rb:"text/x-script.ruby",rdf:"application/rdf+xml",roff:"text/troff",rpm:"application/x-redhat-package-manager",rss:"application/rss+xml",rtf:"application/rtf",ru:"text/x-script.ruby",s:"text/x-asm",sgm:"text/sgml",sgml:"text/sgml",sh:"application/x-sh",sig:"application/pgp-signature",snd:"audio/basic",so:"application/octet-stream",svg:"image/svg+xml",svgz:"image/svg+xml",swf:"application/x-shockwave-flash",t:"text/troff",tar:"application/x-tar",tbz:"application/x-bzip-compressed-tar",tcl:"application/x-tcl",tex:"application/x-tex",texi:"application/x-texinfo",texinfo:"application/x-texinfo",text:"text/plain",tif:"image/tiff",tiff:"image/tiff",torrent:"application/x-bittorrent",tr:"text/troff",txt:"text/plain",vcf:"text/x-vcard",vcs:"text/x-vcalendar",vrml:"model/vrml",war:"application/java-archive",wav:"audio/x-wav",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",wmx:"video/x-ms-wmx",wrl:"model/vrml",wsdl:"application/wsdl+xml",xbm:"image/x-xbitmap",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xslt:"application/xslt+xml",yaml:"text/yaml",yml:"text/yaml",zip:"application/zip",default:"text/html"};var c={getMime:t=>{const e=t.lastIndexOf(".");return p[t.substr(e+1).toLowerCase()]||p.default},mimes:p};const l={br:o.createBrotliCompress,gzip:o.createGzip,deflate:o.createDeflate},{writeHeaders:m}=s,d=c.getMime,f="bytes=";var x=function(t,i,a,o){!function(t,i,a,{lastModified:o=!0,headers:n={},compress:r=!1,compressionOptions:s={priority:["gzip","br","deflate"]},cache:p=!1}={}){let{mtime:c,size:x}=e.statSync(a);c.setMilliseconds(0);const u=c.toUTCString();if(o){if(i["if-modified-since"]&&new Date(i["if-modified-since"])>=c)return t.writeStatus("304 Not Modified"),t.end();n["last-modified"]=u}if(n["content-type"]=d(a),p)return t.onAborted(()=>{}),p.wrap(`${a}_${u}`,t=>{e.readFile(a,t)},{ttl:0},(e,i)=>{if(e)throw t.writeStatus("500 Internal server error"),t.end(),e;m(t,n),t.end(i)});let g=0,h=x-1;if(i.range){r=!1;const e=i.range.replace(f,"").split("-");g=parseInt(e[0],10),h=e[1]?parseInt(e[1],10):h,n["accept-ranges"]="bytes",n["content-range"]=`bytes ${g}-${h}/${x}`,x=h-g+1,t.writeStatus("206 Partial Content")}h<0&&(h=0);let v=e.createReadStream(a,{start:g,end:h}),y=!1;if(r){const t=s.priority.length;for(let e=0;e<t;e++){const t=s.priority[e];if(i["accept-encoding"].indexOf(t)>-1){y=!0;const i=l[t](s);v.pipe(i),v=i,n["content-encoding"]=s.priority[e];break}}}t.onAborted(()=>v.destroy()),m(t,n),y?v.on("data",e=>{v.pause(),t.write(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)),v.resume()}):v.on("data",e=>{const i=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),a=t.getWriteOffset(),[o,n]=t.tryEnd(i,x);n?v.destroy():o||(v.pause(),t.ab=i,t.abOffset=a,t.onWritable(e=>{const[i,a]=t.tryEnd(t.ab.slice(e-t.abOffset),x);return a?v.destroy():i&&v.resume(),i}))}),v.on("error",t.close).on("end",()=>{t.end()})}(t,{"if-modified-since":i.getHeader("if-modified-since"),range:i.getHeader("range"),"accept-encoding":i.getHeader("accept-encoding")},a,o)},u=function(t,i={}){return i.headers={"content-type":t},new Promise((t,a)=>{const o=new n(i),s={};this.bodyStream().pipe(o),o.on("limit",()=>{i.abortOnLimit&&a("limit")}),o.on("file",function(t,a,o,n,p){const c={filename:o,encoding:n,mimetype:p};if("string"==typeof i.tmpDir){const t=path.join(i.tmpDir,o);r(path.dirname(t)),a.pipe(e.createWriteStream(t)),c.filePath=t}else i.onFile(t,a,o,n,p);g(s,t,c)}),o.on("field",function(t,e){"function"==typeof i.onField&&i.onField(t,e),g(s,t,e)}),o.on("finish",function(){t(s)}),o.on("error",a)})};function g(t,e,i){"[]"===e.slice(-2)?(e=e.slice(0,e.length-2),Array.isArray(t[e])?t[e].push(i):t[e]=[i]):Array.isArray(t[e])?t[e].push(i):t[e]?t[e]=[t[e],i]:t[e]=i}var h=function t(a,{filter:o=(()=>!0),basePath:n=""}={}){let r;const s=[];return(r=e.statSync(a).isDirectory()?e.readdirSync(a).filter(o).map(t=>i.join(a,t)):[a]).forEach(a=>{if(e.statSync(a).isDirectory())s.push(...t.call(this,a,{filter:o,basePath:n}));else if(".js"===i.extname(a)){const t=function(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}();let e=t.basePath||[""];delete t.basePath,"string"==typeof e&&(e=[e]),e.forEach(e=>{for(const i in t){const a=t[i];for(let t in a)Array.isArray(a[t])||(a[t]=[a[t]]),this[i](n+e+t,...a[t]),s.push(n+e+t)}})}}),s};const{Readable:v}=a,y=["application/x-www-form-urlencoded","multipart/form-data"],b=()=>!0;class w{file(t,e,i){return this.get(t,(t,a)=>{x(t,a,e,i)}),this}folder(t,a,o,n=a){if(!e.statSync(a).isDirectory())throw Error("Given path is not a directory: "+a);"/"!==t[0]&&(t="/"+t),"/"===t[t.length-1]&&(t=t.slice(0,-1));const r=o&&o.filter||b;return e.readdirSync(a).forEach(s=>{const p=i.join(a,s);if(r(p))if(e.statSync(p).isDirectory())this.folder(t,p,o,n);else{const e="/"+i.relative(n,p);if(this._staticPaths[t+e])return;this._staticPaths[t+e]=[p,o],this.get(t+e,this._serveStatic)}}),o&&o.watch&&this._watched.indexOf(a)<0&&(e.watch(a,(s,p)=>{if("rename"===s){if(!p)return;const s=i.join(a,p),c="/"+i.relative(n,s);e.existsSync(s)&&r(s)?(this._staticPaths[t+c]=[s,o],this.get(t+c,this._serveStatic)):delete this._staticPaths[t+c]}}),this._watched.push(a)),this}_serveStatic(t,e){const i=this._staticPaths[e.getUrl()];void 0===i?(t.writeStatus("404 Not Found"),t.end()):x(t,e,i[0],i[1])}post(t,e){if("function"!=typeof e)throw Error(`handler should be a function, given ${typeof e}.`);return this._post(t,(t,i)=>{const a=i.getHeader("content-type");t.bodyStream=function(){const t=new v;return t._read=b,this.onData((e,i)=>{t.push(new Uint8Array(e.slice(e.byteOffset,e.byteLength))),i&&t.push(null)}),t},t.body=function(){return new Promise(t=>{const e=[],i=this.bodyStream();i.on("data",e.push.bind(e)),i.on("end",()=>{switch(e.length){case 0:t(Buffer.allocUnsafe(0));break;case 1:t(e[0]);break;default:t(Buffer.concat(e))}})})},a.indexOf("application/json")>-1&&(t.json=(async()=>JSON.parse(await t.body()))),y.map(t=>a.indexOf(t)>-1).indexOf(!0)>-1&&(t.formData=u.bind(t,a)),e(t,i)}),this}load(t,e){return h.call(this,t,e),this}listen(t,e=b,i){return"function"==typeof i?this._listen(t,e,t=>{this._socket=t,i(t)}):this._listen(t,t=>{this._socket=t,e(t)}),this}close(){this._socket&&(t.us_listen_socket_close(this._socket),this._socket=null)}}w.prototype._staticPaths={},w.prototype._watched=[];var j=w;const{extend:S}=s;var _=class extends t.App{constructor(t={}){super(t),S(this,j)}};const{extend:O}=s;var A={App:_,SSLApp:class extends t.SSLApp{constructor(t){super(t),O(this,j)}},mimes:c.mimes,getMime:c.getMime,writeHeaders:s.writeHeaders,sendFile:x},k=A.App,P=A.SSLApp,z=A.mimes,H=A.getMime,D=A.writeHeaders,E=A.sendFile;export default A;export{k as App,P as SSLApp,H as getMime,z as mimes,E as sendFile,D as writeHeaders};
/*! (c) @aadityataparia */
