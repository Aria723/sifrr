{"version":3,"file":"livereload.js","sources":["../../src/server/livereload.js","livesrc.js"],"sourcesContent":["const websockets = {};\nlet id = 0;\n\nconst wsConfig = {\n  open: ws => {\n    websockets[id] = {\n      dirty: false\n    };\n    ws.id = id;\n    console.log('websocket connected: ', id);\n    id++;\n  },\n  message: ws => {\n    ws.send(JSON.stringify(websockets[ws.id].dirty));\n    websockets[ws.id].dirty = false;\n  },\n  close: (ws, code, message) => {\n    delete websockets[ws.id];\n    console.log(\n      `websocket disconnected with code ${code} and message ${message}:`,\n      ws.id,\n      websockets\n    );\n  }\n};\n\nconst jsCode = path => {\n  let ws,\n    ttr = 500,\n    timeout;\n\n  function newWsConnection() {\n    ws = new WebSocket(path);\n    ws.onopen = function() {\n      ttr = 500;\n      checkMessage();\n      console.log('watching for file changes through sifrr-server livereload mode.');\n    };\n    ws.onmessage = function(event) {\n      if (JSON.parse(event.data)) {\n        console.log('Files changed, refreshing page.');\n        location.reload();\n      }\n    };\n    ws.onerror = e => {\n      console.error('Webosocket error: ', e);\n      console.log('Retrying after ', ttr / 4, 'ms');\n      ttr *= 4;\n    };\n    ws.onclose = e => {\n      console.error(`Webosocket closed with code ${e.code} error ${e.message}`);\n    };\n  }\n\n  function checkMessage() {\n    if (!ws) return;\n    if (ws.readyState === WebSocket.OPEN) ws.send('');\n    else if (ws.readyState === WebSocket.CLOSED) newWsConnection();\n\n    if (timeout) clearTimeout(timeout);\n    timeout = setTimeout(checkMessage, ttr);\n  }\n\n  newWsConnection();\n  setTimeout(checkMessage, ttr);\n};\n\nconst sendSignal = (type, path) => {\n  console.log(type, 'signal for file: ', path);\n  for (let i in websockets) websockets[i].dirty = true;\n};\n\nmodule.exports = {\n  websockets,\n  wsConfig,\n  jsCode,\n  sendSignal\n};\n","import { jsCode } from '../../src/server/livereload';\n\nconst loc = window.location;\nlet uri;\nif (loc.protocol === 'https:') {\n  uri = 'wss:';\n} else {\n  uri = 'ws:';\n}\nuri += '//' + loc.host + '/livereload';\njsCode(uri);\n"],"names":["websockets","id","wsConfig","open","ws","dirty","console","log","message","send","JSON","stringify","close","code","jsCode","path","ttr","timeout","newWsConnection","WebSocket","onopen","checkMessage","onmessage","event","parse","data","location","reload","onerror","e","error","onclose","readyState","OPEN","CLOSED","clearTimeout","setTimeout","sendSignal","type","i","loc","window","uri","protocol","host"],"mappings":"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"}