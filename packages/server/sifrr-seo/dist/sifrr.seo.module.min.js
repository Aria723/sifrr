/*! Sifrr.Seo v0.0.5 - sifrr project | MIT licensed | https://github.com/sifrr/sifrr */
import e from"puppeteer";import t from"cache-manager";const s=["document","script","xhr","fetch"];var n=class{constructor(e,t=(()=>!0)){this.npage=e,this.filter=t,this.pendingRequests=0,this.pendingPromise=new Promise(e=>this.pendingResolver=e),this.addOnRequestListener(),this.addEndRequestListener()}addOnRequestListener(){const e=this;this.addListener=this.npage.setRequestInterception(!0).then(()=>{e.npage.on("request",t=>{(function(e,t){const s=e.resourceType();return-1!==t.indexOf(s)})(t,s)&&this.filter(t.url())?(e.pendingRequests++,t.__allowed=!0,t.continue()):(t.__allowed=!1,t.abort())})})}addEndRequestListener(){const e=this;this.npage.on("requestfailed",t=>{e.onEnd(t)}),this.npage.on("requestfinished",t=>{e.onEnd(t)})}onEnd(e){e.__allowed&&(this.pendingRequests--,0===this.pendingRequests&&this.pendingResolver())}all(){return 0===this.pendingRequests?Promise.resolve(!0):this.pendingPromise}};var r=class{constructor(e={},t={}){this.status=0,this.puppeteerOptions=Object.assign({headless:!0,args:[]},e),this.puppeteerOptions.args.push("--no-sandbox","--disable-setuid-sandbox"),this.options=t}async browserAsync(){return this._browser||(this._browser=e.launch(this.puppeteerOptions).then(e=>(e.on("disconnected",()=>{this._browser=null}),e))),this._browser}close(){return this._browser?this.browserAsync().then(e=>e.close()):Promise.resolve(!0)}render(e,t={}){const s=this;return this.browserAsync().then(e=>e.newPage()).then(async r=>{const i=new n(r,s.options.filterOutgoingRequests);await i.addListener,delete t["user-agent"],await r.setExtraHTTPHeaders(t),s.options.beforeRender&&await r.evaluateOnNewDocument(s.options.beforeRender);const o=await r.goto(e,{waitUntil:"load"});let h;return s.isHTML(o)?(await i.all(),s.options.afterRender&&await r.evaluate(s.options.afterRender),h=await r.content()):h=!1,await r.close(),h})}isHTML(e){return e.headers()["content-type"]&&e.headers()["content-type"].indexOf("html")>=0}},i=e=>(e=Object.assign({cacheStore:"memory",maxCacheSize:100,ttl:0},e),t.caching({store:e.cacheStore,ttl:e.ttl,length:(e,t)=>Buffer.from(t+t+e).length+2,max:1e6*e.maxCacheSize}));const{headerName:o,headerValue:h}={noop:()=>{},headerName:"X-SSR-Powered-By",headerValue:"@sifrr/seo"};var a=e=>(function(t,s,n){if("GET"!==t.method)return n();const r=e(t),i=t.headers;return null===this.getShouldRenderCache(r,i)&&(s._end=s.end,s.end=(e,t)=>{if(s.hasHeader("content-type")){s.getHeader("content-type").indexOf("html")>=0?this.setShouldRenderCache(r,i,!0):this.setShouldRenderCache(r,i,!1)}s._end(e,t)}),this.render(r,i).then(e=>{e?(s.set(o,h),s.send(e)):n()}).catch(e=>{"No Render"===e.message?n():n(e)})});const d=new RegExp("(headless|Headless)");class c{constructor(e=["Googlebot","Bingbot","Slurp","DuckDuckBot","Baiduspider","YandexBot","Sogou","Exabot"],t={}){this._uas=e.map(e=>new RegExp(e)),this.shouldRenderCache={},this.options=Object.assign({cacheKey:e=>e},t)}get renderer(){return this._renderer=this._renderer||new c.Renderer(this._poptions,this.options),this._renderer}get cache(){return this._cache=this._cache||i(this.options),this._cache}getExpressMiddleware(e=(e=>`http://127.0.0.1:80${e.originalUrl}`)){return a(e).bind(this)}addUserAgent(e){this._uas.push(new RegExp(e))}setPuppeteerOption(e,t){this._poptions=this._poptions||{},this._poptions[e]=t}close(){return this.renderer.close()}shouldRender(e,t){return this._isUserAgent(t)}setShouldRenderCache(e,t,s){const n=this.options.cacheKey(e,t);this.shouldRenderCache[n]=s}getShouldRenderCache(e,t){const s=this.options.cacheKey(e,t);return void 0===this.shouldRenderCache[s]?null:this.shouldRenderCache[s]}clearCache(){this.cache.reset()}async render(e,t){if(!1===this.getShouldRenderCache(e,t))throw Error("No Render");if(this.shouldRender(e,t)&&!this._isHeadless(t)){const s=this.options.cacheKey(e,t);return new Promise((n,r)=>{this.cache.get(s,(i,o)=>{i?r(i):o?n(o):this.renderer.render(e,t).then(e=>{this.cache.set(s,e),n(e)}).catch(e=>{r(e)})})})}throw Error("No Render")}_isHeadless(e={}){return!!d.test(e["user-agent"])}_isUserAgent(e={}){const t=e["user-agent"];let s=!1;return this._uas.forEach(e=>{e.test(t)&&(s=!0)}),s}}c.Renderer=r;export default c;
/*! (c) @aadityataparia */
